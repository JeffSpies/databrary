@(record : models.Record, meas : Seq[Metric[_]], form : RecordHtml.EditForm, jsonCategories : Html, jsonMetrics : Html)(implicit request : RequestObject[SiteObject]#Site[_])

@implicitField = @{
    helper.FieldConstructor(widget.tag.minimalFieldConstructor.f)
}

@template.form(Some(record), "Edit Record") {
            @widget.formErrors(form)

            <form metrics-repeater class="repeater" ng-init='formAction = "/record/@record.id.toString/edit"; category = @form("Category").value.getOrElse("undefined"); categories = @jsonCategories; metrics = @jsonMetrics; repeats = @form.data.filter(i => i._1.contains("measure")).map(i => (i._1.split("\\.").head, i._1.split("\\.").last, i._2)).groupBy(i => i._1).map(i => i._2.map(i => i._2+": '"+i._3+"'").mkString("{",",","}")).mkString("[",",","]")'>

                <div class="field cf" id="category_field">
                    <label for="category">Record Category</label>

                    <select id="category" name="category" ng-model="category" ng-options="cat.id as cat.name for cat in categories" ng-change="updateCategory(category)"></select>
                </div>

                <fieldset>
                    <legend>Metrics</legend>

                    <div ng-repeat="repeat in repeats" class="repeat">
                        <div class="repeat_repeated">
                            <div class="field cf" id="measure_{{$index}}__metric_field">
                                <label for="measure_{{$index}}__metric">{{(thisMetric = getMetric(repeat.metric)).name}} ({{thisMetric.classification}})</label>

                                <input type="hidden" id="measure_{{$index}}__metric" name="measure[{{$index}}].metric" ng-init="" ng-model="repeat.metric">
                            </div>

                            <div class="field cf" id="measure_{{$index}}__datum_field" ng-switch="thisMetric.dataType">
                                <input ng-switch-when="date" type="date" id="measure_{{$index}}__datum" name="measure[{{$index}}].datum" ng-model="repeat.datum">

                                <select ng-switch-when="select" ng-model="repeat.datum" ng-options="value as value for value in thisMetric.values"></select>

                                <input ng-switch-default type="text" id="measure_{{$index}}__datum" name="measure[{{$index}}].datum" ng-model="repeat.datum">
                            </div>
                        </div>

                        <div class="repeat_controls">
                            <div class="repeat_control repeat_crud repeat_delete" ng-click="deleteRepeat(repeat)">-</div>
                            <div class="repeat_control repeat_move" ng-if="isMovable()"></div>
                            <div class="repeat_control repeat_crud repeat_add" ng-click="createRepeat()" ng-if="isAddable()" ng-show="$last">+</div>
                        </div>
                    </div>

                    <div class="repeat">
                        <div class="repeat_repeated">
                            <div class="field cf" id="measure_{{$index}}__datum_field">
                                <label for="measure_{{$index}}__metric">Add new metric...</label>
                                <select ng-model="newMetric" ng-options="m.id as m.name for m in metrics | filter:{used: false}" ng-change="createRepeat(newMetric)"></select>
                            </div>
                        </div>

                        <div class="repeat_controls"></div>
                    </div>
                </fieldset>

                <button type='submit' class="button" ng-click="submit()">Update</button>
            </form>
}
