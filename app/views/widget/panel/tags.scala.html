@(slot : Slot, volume : Option[Volume] = None, form : controllers.Slot.TagForm = controllers.Slot.tagForm)(implicit request : SiteRequest[_])

@import play.api.data.Form
@import play.api.data.Forms._

@import helper.FieldConstructor
    @implicitField = @{
        FieldConstructor(widget.tag.minimalFieldConstructor.f)
    }

@defining(Async.wait(volume.fold(slot.tags())(_.tags))) { tags =>
    @widget.panel.raw("tags", "", "ng-controller" -> "TagsPanelCtrl", "ng-init" -> {tags.map(t => "{id: "+t.tag.id+", name: '"+t.tag.name+"', weight: "+t.weight+", vote: "+(if(t.user.isEmpty){0}else{if(t.user.get){1}else{-1}})+"}").mkString("tags = [",",","];")+" formAction = '/volume/"+slot.volume.id+"/slot/"+slot.id+"/tag'"})(title = "Tags", foldable = true){
        <div class="panel_tags_list col-desktop-6 col-laptop-6 col-tablet-6 col-mobile-3">
            @widget.angular.dbMode {
                <form name="tagForm" novalidate>
                    <ol class="panel_tags_items row">
                        <li ng-repeat="tag in tags" id="tag_{{tag.id}}" class="panel_tags_item col-desktop-3 col-laptop-3 col-tablet-3 col-mobile-6">
                            <div class="controls">
                                <button class="vote down" name="vote" ng-click="voteDown(tag);" ng-disabled="tag.vote == -1">-</button>
                                <button class="vote null" name="vote" ng-click="voteNone(tag)" ng-disabled="tag.vote == 0">0</button>
                                <button class="vote up" name="vote" ng-click="voteUp(tag)" ng-disabled="tag.vote == 1">+</button>
                            </div>

                            <span class="name">{{tag.name}}</span>

                            <span class="weight">{{tag.weight}}</span>
                        </li>
                    </ol>
                </form>
            } {
                <ol class="panel_tags_items row">
                    @if(tags.nonEmpty) {
                        @tags.map { case TagWeight(tag, weight, user) =>
                            <li id="tag_@tag.id" class="panel_tags_item col-desktop-3 col-laptop-3 col-tablet-3 col-mobile-6">
                            @widget.tag.form(routes.Slot.tag(slot.volumeId, slot.id)) {
                                @widget.tag.inputHidden(form("name").copy(value = Some(tag.name)), 'id -> Html("name-"+tag.id.toString))(widget.tag.rawFieldConstructor.f, Lang("en"))


                                <div class="controls">
                                    <button class="vote down" name="vote" value="false" @if(!user.getOrElse(true)){disabled}>-</button>
                                    <button class="vote null" name="vote" value="" @if(user.isEmpty){disabled}>0</button>
                                    <button class="vote up" name="vote" value="true" @if(user.getOrElse(false)){disabled}>+</button>
                                </div>

                                <span class="name">@tag.name</span>

                                <span class="weight">@weight</span>
                            }
                            </li>
                        }
                    }
                </ol>
            }
        </div>

        <div id="tag_add" class="panel_tags_form col-desktop-6 col-laptop-6 col-tablet-3 col-mobile-6">
            @widget.angular.dbMode {
                <form name="tagNewForm" novalidate ng-submit="voteNew()">
                    <input type="text" name="name" ng-model="newName" placeholder="Add new tag..." required ng-maxlength="32" ng-minlength="3" ng-pattern="/^[a-zA-Z][a-zA-Z -]{1,30}[a-zA-Z]$/">
                    <button name="vote" ng-click="voteUp(tag)" class="hide">add</button>
                </form>
            }{
                @widget.tag.form(routes.Slot.tag(slot.volumeId, slot.id)) {
                    @widget.tag.inputText(form("name"), 'placeholder -> "Add new tag")
                    <button name="vote" value="@true" class="hide">add</button>
                }
            }

        </div>
    }
}
