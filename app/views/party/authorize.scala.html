@(authorizeParents : Seq[Authorize], authorizeForms : Seq[PartyController.AuthorizeForm])(implicit request : PartyHtml.Request[_])

@implicitField = @{
    helper.FieldConstructor(widget.tag.tableFieldConstructor.f)
}

@import PartyController._

@authList(which : Boolean)(implicit fieldConstructor : helper.FieldConstructor) = {
    <h3>@{if(which) "Memberships" else "Authorizations"}</h3>

    <table>
    <thead>
	<tr>
	    <th rowspan=2>Name</th>
	    <th colspan=3>Access permissions granted for:</th>
	    <th rowspan=2>Expiration</th>
	    <th rowspan=2>Action</th>
	</tr>
	<tr>
	    <th>Databrary data (Investigator status)</th>
	    <th>@{if(which) "Their" else if(request.obj === request.identity) "My" else request.obj.party.name + "'s"} data</th>
	    <th>Administrative tasks</th>
	</tr>
    </thead>

    <tbody>
    @if(which) {
    @authorizeParents.map { t =>
	<tr>
	    <td>@display(t.parent)</td>
	    <td>@Permission.message(t.inherit, "inherit")</td>
	    <td>@Permission.message(t.direct, "direct")</td>
	    <td>@Permission.message(t.permission, "permission")</td>
	    <td>@t.expires.fold("never")( e => display.dateFmtYMD.print(e) )</td>
	    <td>@{if(t.authorized.isEmpty) "pending"}</td>
	</tr>
    }
    }
    @authorizeForms.filter(_._apply == which).map { form =>
	@widget.tag.form(form._action) {
	    <tr>
		@form match {
		case form : AuthorizeSearchForm => {
		    @widget.tag.inputText(form.name(), 'id -> ("name_"+which.toString))
		}
		case form : AuthorizeOtherForm => {
		<td>
		    @display(form.targetParty)
		    @form.targetParty.email.map { e =>
		        <br/>&lt;@e&gt;
		    }
		    @form.info.get.map { info =>
			OSP: @info
		    }
		</td>
		}
		}

		@widget.tag.select(form.inherit(), Permission.values.toSeq.flatMap(p => Permission.message(p, "inherit").map((p.id.toString, _))))

		@form match {
		case form : AuthorizeChildForm => {
		    @widget.tag.select(form.direct(), Permission.values.toSeq.flatMap(p => Permission.message(p, "direct").map((p.id.toString, _))))

		    @widget.tag.select(form.permission(), Permission.values.toSeq.flatMap(p => Permission.message(p, "permission").map((p.id.toString, _))))

		    @widget.tag.inputDate(form.expires(), 'placeholder -> "Expiration date", 'class -> "half")
		}
		case _ => {
		@if(form.inherit.get == Permission.CONTRIBUTE) {
		    @widget.tag.inputText(form.info(), 'placeholder -> "Contact info for your institution's authorizing official (OSP)", '_colspan -> 3)
	        } else {
		    <td colspan="3"/>
		}
		}
		}

		<td>
		@form match {
		case form : AuthorizeSearchForm => {
		    <input type='hidden' name='pending' value='true'/>
		    <button type='submit' class="button third">Search</button>
		@if(form.inherit.get == Permission.CONTRIBUTE && form.name.get.nonEmpty) {
		    <button type='submit' class="button first" name='notfound' value='true'>Not found</button>
		}
		}
		case form : AuthorizeApplyForm => {
		    <button type='submit' class="button">Request</button>
		}
		case form : AuthorizeChildForm => {
		    <button type='submit' class="button second">@{if(form.pending.get) "Authorize" else "Update"}</button>
		    <button type='submit' class="button first" name='delete' value='true'>@{if(form.pending.get) "Deny" else "Revoke"}</button>
		}
		}
		@widget.formErrors(form())
		</td>
	    </tr>
	}
    }
    </tbody>
    </table>
}

@template.form(Some(request.obj.party), "Admin Party") {
	@authList(true)
	@authList(false)
}
