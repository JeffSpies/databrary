@(authorizeParents : Seq[Authorize], authorizeForms : Seq[(Party,PartyHtml.AuthorizeForm)], authorizeWhich : Option[Boolean], authorizeSearch : Form[String], authorizeResults : Seq[(Party,PartyHtml.AuthorizeForm)])(implicit request : PartyHtml.Request[_])

@import helper.FieldConstructor

    @implicitField = @{
        FieldConstructor(widget.tag.minimalFieldConstructor.f)
    }

@authorizeFields(party : Party, form : controllers.PartyHtml.AuthorizeForm, full : Boolean = true)(implicit fieldConstructor : helper.FieldConstructor) = {
    <td>
        @display(party)
    </td>

    <td>
        @widget.tag.select(form("inherit"), Permission.values.toSeq.flatMap(p => Permission.message(p, "inherit").map((p.id.toString, _))))
    </td>

    <td>
    @if(full) {
        @widget.tag.select(form("direct"), Permission.values.toSeq.flatMap(p => Permission.message(p, "direct").map((p.id.toString, _))))
    }
    </td>

    <td>
    @if(full) {
        @widget.tag.select(form("permission"), Permission.values.toSeq.flatMap(p => Permission.message(p, "permission").map((p.id.toString, _))))
    }
    </td>

    <td>
    @if(full) {
        @widget.tag.inputDate(form("expires"), 'placeholder -> "Expiration date", 'class -> "half")
    }
    </td>
}

@authorizeSearchWhich(party : Party, which : Boolean)(implicit fieldConstructor : helper.FieldConstructor) = {
    @if(authorizeWhich.forall(_ == which)) {
            <tr class="null">
                <td>
                @widget.tag.form(routes.PartyHtml.authorizeSearch(party.id, which), 'id -> ("search_"+which.toString)) {
                    @widget.tag.inputText(authorizeSearch("name"), 'id -> ("name_"+which.toString))
                    @widget.formErrors(authorizeSearch)
                }
                </td>

                <td/>
                <td/>
                <td/>

                <td>
                    <button type='submit' class="button third" form="search_@which.toString">Search</button>
                </td>
            </tr>

        @authorizeResults.map { case (other,form) =>
            <tr>
                @widget.tag.form(if (which) routes.PartyHtml.authorizeApply(party.id, other.id) else routes.PartyHtml.authorizeChange(party.id, other.id), 'id -> ("which_"+which.toString)) {
                    @authorizeFields(other, form)
                    @widget.formErrors(form)
                }

                <td>
                    <input type='hidden' name='pending' value='@which'/>
                    <button type='submit' class="button" form="which_@which.toString">@{if (which) "Request" else "Authorize"}</button>
                </td>
            </tr>
        }
    }
}

@authList(which : Boolean) = {
            <h3>@{if(which) "Memberships" else "Authorizations"}</h3>

            <table>
                <thead>
                    <tr>
                        <th rowspan=2>Name</th>
                        <th colspan=3>Access permissions granted for:</th>
                        <th rowspan=2>Expiration</th>
                        <th rowspan=2>Action</th>
                    </tr>
                    <tr>
			<th>Databrary data (Investigator status)</th>
			<th>@{if(which) "Their" else if(request.obj === request.identity) "My" else request.obj.party.name + "'s"} data</th>
			<th>Administrative tasks</th>
                    </tr>
                </thead>

                <tbody>
		@if(which) {
                @authorizeParents.map { t =>
                    <tr>
                        <td>@display(t.parent)</td>
                        <td>@Permission.message(t.inherit, "inherit")</td>
                        <td>@Permission.message(t.direct, "direct")</td>
                        <td>@Permission.message(t.permission, "permission")</td>
                        <td>@t.expires.fold("never")( e => display.dateFmtYMD.print(e) )</td>
                        <td>@{if(t.authorized.isEmpty) "pending"}</td>
                    </tr>
                }
		} else {
                @authorizeForms.map { case (child,form) =>
                    @widget.tag.form(routes.PartyHtml.authorizeChange(request.obj.party.id, child.id)) {
                        <tr>
                            @authorizeFields(child, form)
                            <td>
                            @defining(form("pending").value == Some("true")) { pending =>
                                <button type='submit' class="button second">@{if(pending) "Authorize" else "Change"}</button>
                                <a href='@routes.PartyHtml.authorizeDelete(request.obj.party.id, child.id)' class="button first">@{if(pending) "Deny" else "Revoke"}</a>
                            @widget.formErrors(form)
                            }
                            </td>
                        </tr>
                    }
                }
		}
                </tbody>


                <tfoot>
                    @authorizeSearchWhich(request.obj.party, which)
                </tfoot>
            </table>
}

@template.form(Some(request.obj.party), "Admin Party") {
	@authList(true)
	@authList(false)
}
