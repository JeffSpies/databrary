@(a : Either[SiteParty, Volume], editForm : VolumeHtml.VolumeForm)(implicit request : RequestObject[SiteObject]#Site[_])

@import helper.FieldConstructor

    @implicitField = @{
        FieldConstructor(widget.tag.labeledFieldConstructor.f)
    }

@widget.template.crud(a.fold(_.toString + ": Create Volume", "Edit Volume: " + _.name)) {
    @widget.panel.form(a.fold(_ => "", _.pageName), a.fold(_ => "Create Volume", _ => "Edit Volume")) {
        <div class="col-full">
        @widget.tag.form(a.fold(p => routes.VolumeHtml.add(p.party.id), s => routes.VolumeHtml.update(s.id))) {
            @widget.formErrors(editForm)

            @widget.tag.inputText(editForm("name"), 'placeholder -> "Title", '_class -> "")
            @widget.tag.textarea(editForm("body"), 'placeholder -> "Description", '_class -> "")

            <fieldset class="publications">
                <legend>Publications</legend>

                <div repeater class="repeater" ng-init="repeats = @editForm.data.filter(i => i._1.contains("citation")).map(i => (i._1.split("\\.").head, i._1.split("\\.").last, i._2)).groupBy(i => i._1).map(i => i._2.map(i => i._2+": '"+i._3+"'").mkString("{",",","}")).mkString("[",",","]")">
                    @angular.directives.mode {
                        <div ng-repeat="repeat in repeats" class="repeat">
                            <div class="repeat_repeated">
                               <div class="field cf" id="citation_{{$index}}__head_field">
                                   <label for="citation_{{$index}}__head">Citation</label>
                                   <input type="text" id="citation_{{$index}}__head" name="citation[{{$index}}].head" ng-model="repeat.head">
                               </div>

                               <div class="field cf" id="citation_{{$index}}__url_field">
                                   <label for="citation_{{$index}}__url">DOI or URL</label>
                                   <input type="text" id="citation_{{$index}}__url" name="citation[{{$index}}].url" ng-model="repeat.url">
                               </div>

                               <div class="field cf" id="citation_{{$index}}__body_field">
                                   <label for="citation_{{$index}}__body">Abstract</label>
                                   <textarea type="text" id="citation_{{$index}}__body" name="citation[{{$index}}].body" ng-model="repeat.body"></textarea>
                               </div>
                            </div>

                            <div class="repeat_controls">
                                <div class="repeat_control repeat_crud repeat_delete" ng-click="deleteRepeat(repeat)">-</div>
                                <div class="repeat_control repeat_move" ng-show="isMovable()"></div>
                                <div class="repeat_control repeat_crud repeat_add" ng-click="createRepeat()" ng-show="$last">+</div>
                            </div>
                        </div>
                    } {
                        @widget.tag.repeat(editForm("citation")) { f =>
                            @widget.tag.inputText(f("head"), 'placeholder -> "Citation")
                            @widget.tag.inputText(f("url"), 'placeholder -> "DOI or URL")
                            @widget.tag.textarea(f("body"), 'placeholder -> "Abstract")
                        }
                    }
                </div>
            </fieldset>

            <button type="submit" class="button">@a.fold(_ => "Create", _ => "Change")</button>
        }
        </div>
    }
}
