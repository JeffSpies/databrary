@(c : Either[Volume, Slot], form : SlotHtml.EditForm, recordForm : Option[controllers.Record.SelectForm], selectList : Seq[(String,String)] = Nil)(implicit request : RequestObject[SiteObject]#Site[_])

@import helper.FieldConstructor

@implicitField = @{
    FieldConstructor(widget.tag.labeledFieldConstructor.f)
}

@widget.template.crud(c.fold(v => "Create Session in Volume: " + v.name, s => "Edit Session: " + s.container.name + " (#" + s.id.toString + ")")) {
    @widget.panel.form(c.fold(v => v.name, s => s.container.name + " (#" + s.id.toString + ")"), c.fold(v => "Create Session in Volume", s => "Edit Session")) {
        <div class="col-full">
            @widget.formErrors(form)

            @widget.tag.form(c.fold(volume => routes.SlotHtml.addContainer(volume.id), slot => routes.SlotHtml.change(slot.volumeId, slot.id)), 'id -> "slot_edit") {
                @if(form("name").name) {
                    @widget.tag.inputText(form("name"), 'placeholder -> "Name")
                    @widget.tag.inputDate(form("date"), 'placeholder -> "Date", 'class -> "half")
                }

                @widget.enumSelect(form("consent"), Consent)
            }

            @c match {
                case Right(slot) => {
                    <fieldset>
                        <legend>Records</legend>

                        <table class="records">
                            <thead>
                                <tr>
                                    <th class="main">Record</th>
                                    <th class="meta">Category</th>
                                    @recordForm.map { f => <th class="meta">Action</th>}
                                </tr>
                            </thead>

                            <tbody>
                            @defining(Async.wait(slot.records)) { records =>
                                @if(records.nonEmpty) {
                                    @records.map { record =>
                                        <tr>
                                            <td class="main">
                                                @display(record)
                                            </td>

                                            <td class="meta">
                                                @record.category.fold("")(_.name)
                                            </td>

                                            <td class="meta">
                                            @widget.tag.form(controllers.Record.routes.html.slotRemove(slot.volumeId, slot.id, record.id, true)) {
                                                <a href="@controllers.Record.routes.html.edit(record.volume.id, record.id)" class="button">edit</a>

                                                <button type='submit' class="button first">remove</button>
                                            }
                                            </td>
                                        </tr>
                                    }
                                } else {
                                    <tr>
                                        <td class="empty" colspan="@if(recordForm.nonEmpty) {3} else {2}">There are no records assigned.</td>
                                    </tr>
                                }
                            }
                            </tbody>

                            @recordForm.map { f =>
                                <tfoot>
                                    <tr>
                                    @widget.tag.form(controllers.Record.routes.html.slotAdd(slot.volumeId, slot.id, RecordCategory.PARTICIPANT, true)) {
                                        <td colspan="2">
                                        @widget.tag.select(f("record"), selectList, '_default -> "Create new record...", '_colspan -> 2)(widget.tag.minimalFieldConstructor.f, Lang("en"))
                                        </td>

                                        <td>
                                            <button type='submit' class="button third">add participant</button>
                                        </td>
                                    }
                                    </tr>
                                </tfoot>
                            }
                        </table>
                    </fieldset>
                }

                case _ => {

                }
            }

            <button type='submit' class="button" form="slot_edit">Change</button>
        </div>
    }
}
