@(c : Either[Volume, AbstractSlot], form : SlotHtml.EditForm, recordForm : Option[RecordHtml.SelectForm], selectList : Seq[(String,String)] = Nil)(implicit request : RequestObject[SiteObject]#Site[_])

@import helper.FieldConstructor

@implicitField = @{
    FieldConstructor(widget.tag.labeledFieldConstructor.f)
}

@defining(c.fold(_ => "Create Session in Volume", _ => "Edit Session")) { action =>
@defining(c.merge.pageName) { pageName =>
@widget.template.crud(action + ": " + pageName) {
    @widget.panel.form(pageName, action) {
        <div class="col-full">
            @widget.formErrors(form)

            @widget.tag.form(c.fold(volume => routes.SlotHtml.addContainer(volume.id), slot => routes.SlotHtml.update(slot.containerId, slot.segment.lowerBound, slot.segment.upperBound)), 'id -> "slot_edit") {
	        @if(c.fold(_ => true, SlotHtml.formForContainer(form, _))) {
                    @widget.tag.inputText(form("name"), 'placeholder -> "Name")
                    @widget.tag.inputDate(form("date"), 'placeholder -> "Date", 'class -> "half")
                }

                @widget.enumSelect(form("consent"), Consent)
            }
            <button type='submit' class="button" form="slot_edit">Change</button>

            @c match {
                case Right(slot : Slot) => {
                    <fieldset>
                        <legend>Records</legend>

                        <table class="records">
                            <thead>
                                <tr>
                                    <th class="main">Record</th>
                                    <th class="meta">Category</th>
                                    @recordForm.map { f => <th class="meta">Action</th>}
                                </tr>
                            </thead>

                            <tbody>
                            @defining(Async.wait(slot.records)) { records =>
                                @if(records.nonEmpty) {
                                    @records.map { record =>
                                        <tr>
                                            <td class="main">
                                                @display(record)
                                            </td>

                                            <td class="meta">
                                                @record.category.fold("")(_.name)
                                            </td>

                                            <td class="meta">
                                            @widget.tag.form(routes.RecordHtml.remove(record.id, slot.id, true)) {
                                                <a href="@routes.RecordHtml.edit(record.id)" class="button">edit</a>

                                                <button type='submit' class="button first">remove</button>
                                            }
                                            </td>
                                        </tr>
                                    }
                                } else {
                                    <tr>
                                        <td class="empty" colspan="@if(recordForm.nonEmpty) {3} else {2}">There are no records assigned.</td>
                                    </tr>
                                }
                            }
                            </tbody>

                            @recordForm.map { f =>
                                <tfoot>
                                    <tr>
                                    @widget.tag.form(routes.RecordHtml.slotAdd(slot.volumeId, slot.id, RecordCategory.PARTICIPANT, true)) {
                                        <td colspan="2">
                                        @widget.tag.select(f("record"), selectList, '_default -> "Create new record...", '_colspan -> 2)(widget.tag.minimalFieldConstructor.f, Lang("en"))
                                        </td>

                                        <td>
                                            <button type='submit' class="button third">add participant</button>
                                        </td>
                                    }
                                    </tr>
                                </tfoot>
                            }
                        </table>
                    </fieldset>
                }

                case _ => {

                }
            }

        </div>
    }
}
}
}
