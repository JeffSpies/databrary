@(acct : Account, accountForm : Form[(String, String)], trustForms : Seq[(Entity,Form[Trust])], trustSearch : Form[String], trustResults : Seq[(Entity,Form[Trust])])

@tableField(elements : helper.FieldElements) = {
	<td class="@elements.args.get('_class) @if(elements.hasErrors) {error}" id="@elements.args.get('_id).getOrElse(elements.id + "_field")">
		@elements.input
		@elements.errors(elements.lang).map { error =>
			<p class="error">@error</p>
		}
	</td>
}

<!DOCTYPE html>
<html>
	<body>
		<h1>Welcome, @acct.username</h1>
		<a href="@routes.Login.logout">logout</a>

		<h2>Account</h2>
		@helper.form(routes.Account.accountChange) {
			@helper.inputText(accountForm("email"))
			@helper.inputText(accountForm("openid"))
			<button type='submit'>Change</button>
		}
		@formErrors(accountForm)

		<h2>Authorizations</h2>
		<table>
			<tr>
				<th>Name</th>
				<th>Site Access</th>
				<th>Delegated Permissions</th>
				<th>Expiration</th>
				<th>Action</th>
			</tr>

			@trustFields(entity : Entity, form : Form[Trust]) = {
				@defining(helper.FieldConstructor(tableField)) { implicit fieldConstructor =>
				<td>@entity.name</td>
				@helper.select(form("access"), SitePermission.values.toSeq.map(v => (v.id.toString, v.toString)))
				@helper.select(form("delegate"), UserPermission.values.toSeq.map(v => (v.id.toString, v.toString)))
				@helper.inputDate(form("expires"))
				}
			}
			@defining(helper.FieldConstructor(tableField)) { implicit fieldConstructor =>

			<tr><th colspan="5"><h3>Memberships</h3></th></tr>
			@acct.entity.trustParents.map { t =>
			<tr>
				<td>@t.parentEntity.name</td>
				<td>@t.access</td>
				<td>@t.delegate</td>
				<td>@t.expires.getOrElse("never")</td>
			</tr>
			}

			<tr><th colspan="5"><h3>Authorizations</h3></th></tr>

			@trustForms.map { case (child,form) =>
			@helper.form(routes.Account.trustChange(child.id)) {
			<tr>
				@trustFields(child, form)
				<td>
					<button type='submit'>Change</button>
					<a href='@routes.Account.trustDelete(child.id)'>Remove</a>
					@formErrors(form)
				</td>
			</tr>
			}
			}

			@helper.form(routes.Account.trustSearch) {
			<tr>
				@helper.inputText(trustSearch("name"))
				<td/>
				<td/>
				<td/>
				<td>
					<button type='submit'>Search</button>
					@formErrors(trustSearch)
				</td>
			</tr>
			}

			@trustResults.map { case (child,form) =>
			@helper.form(routes.Account.trustAdd(child.id)) {
			<tr>
				@trustFields(child, form)
				<td>
					<button type='submit'>Authorize</button>
					@formErrors(form)
				</td>
			</tr>
			}
			}

			}
		</table>
	</body>
</html>
