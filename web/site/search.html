<article class="view search-view">
  <div class="wrap">
    <ng-form name="searchForm">
    <div class="row">
      <div class="col">
        <h1 class="panel-title smaller">
          <span>Search</span>
          <input class="search-input" type="search" ng-model="query" key-enter="search()"/>
        </h1>
      </div>
    </div>
    <div class="col-desktop-3 col-tablet-3 col-mobile-6">
      
      <button class="search-clear small" ng-click="page.$location.search({})">Clear current search</button>

      <div class="search-left-section" ng-if="::!!parties">
        <legend>User types</legend>
        <ul class="search-party-types">
          <li ng-click="searchParties(page.constants.permission.EDIT, 'false')" ng-class="::{selected:fields.party_authorization == page.constants.permission.EDIT && fields.party_is_institution == 'false'}">Authorized investigators</li>
          <li ng-click="searchParties(page.constants.permission.ADMIN, 'true')" ng-class="::{selected:fields.party_authorization == page.constants.permission.ADMIN && fields.party_is_institution == 'true'}">Authorized institutions</li>
          <li ng-click="searchParties()" ng-class="::{selected:fields.party_authorization == null && fields.party_is_institution == null}">All users and groups</li>
        </ul>
      </div>

      <div class="search-left-section" ng-if="::!!volumes">
        <legend>Volume types</legend>
        <div class="search-volume-types">
          <div>
            <input id="volWSess" type="checkbox" ng-model="fields.container_top" ng-true-value="'false'" ng-false-value="undefined" ng-change="searchVolumes()"/>
            <label for="volWSess">Has sessions</label>
          </div>
          <div>
            <input id="volWHighlights" type="checkbox" ng-model="fields.content_type" ng-true-value="'excerpt'" ng-false-value="undefined" ng-change="searchVolumes()"/>
            <label for="volWHighlights">Has highlights</label>
          </div>
        </div>
        <ng-form name="searchVolumeFilter">
          <div class="search-filter">
            <legend>Volume filters</legend>
            <input type="radio" ng-model="fields.release" ng-value="::undefined" id="anyRelease"><label for="anyRelease">Any release</label><br/>
            <input type="radio" ng-model="fields.release" value="EXCERPTS OR PUBLIC" id="excerpt"><label for="excerpt">Excerptable data</label><br/>
            <input type="radio" ng-model="fields.release" value="PUBLIC" id="public"><label for="public">Public data</label>
          </div>
          <div class="search-filter" ng-if="fields.container_top">
            Data collected betweeen <input type="number" ng-model="fields.container_date[0]" min="1925" max="2025" key-enter="search()"/> and <input type="number" ng-model="fields.container_date[1]" min="1925" max="2025" key-enter="search()"/>
          </div>
          <div class="search-filter">
            Contains tag:
            <input-completer input-name="tag" ng-model="fields.tag_name" completer="tagSearch($input)" ng-pattern="/^[a-zA-Z][a-zA-Z -]{1,30}[a-zA-Z]$/" submit="search()"></input-completer>
          </div>
          <div class="search-filter">
            Contains files of type:
            <select ng-model="fields.format_id" ng-options="'\\'+fi as f.name+' ('+f.extension+')' for (fi, f) in ::page.constants.format">
              <option value="">Any</option>
            </select>
          </div>

          <div class="search-filter">
            <span>Participants' age</span><br>
            <div ui-slider="{range:true}" min="0" max="{{ageMax()}}" step="1" ng-model="fields.record_age"></div>
            <display-age value="fields.record_age[0]"></display-age> &ndash; <display-age value="fields.record_age[1]"></display-age>
          </div>
          <div class="search-filter" ng-repeat="(mi, v) in metrics" ng-if="metrics[mi] !== null" ng-init="m=page.constants.metric[mi]">
            <span class="icon trash" ng-click="removeMetric(mi)"></span>
            <span ng-bind="::m.name"></span>
            <input-completer ng-if="::m.options" input-name="metric" ng-model="metrics[mi]" completer="optionsCompleter($input, m.options)" min="0" submit="search()"></input-completer>
            <input type="text" ng-if="::m.type==='text' && !m.options" ng-model="metrics[mi]" key-enter="search()"/>
            <span ng-if="::m.type==='numeric'">
              <input type="number" ng-model="metrics[mi][0]"/> &ndash; <input type="number" ng-model="metrics[mi][1]"/>
            </span>
          </div>
          <div class="search-filter additional-filters">
            <select ng-model="addMetric.id" ng-options="m.id as m.name for m in availableMetrics()" ng-change="addMetric()">
              <option value="">Additional filters by metric</option>
            </select>
          </div>
          <div class="search-filter">
            <button class="small green" ng-disabled="searchVolumeFilter.$pristine || searchVolumeFilter.$invalid || searchVolumeFilter.$submitted" ng-click="searchVolumes()">Apply filters</button>

          </div>
        </div>

      </ng-form>
    </div>

    <div class="search-results col-desktop-12 col-tablet-6 col-mobile-6">
      <small class="status" ng-if="::!!spellcheck">
        Did you mean:
        <span ng-repeat="(w, ss) in ::spellcheck" ng-if="query.includes(w)">
          <a ng-repeat="s in ::ss" class="search-suggestion" ng-click="searchSpellcheck(w, s)"> {{::s}}</a>
        </span>?
      </small>

      <div class="search-results-section" ng-if="::!!parties">
        <h3>
          Users
          <button class="mini small" ng-if="::!!volumes" ng-click="searchParties()">show all {{::parties.count}}</button>
          <small ng-if="::!volumes">{{::parties.count}} total</small>
        </h3>
        
        <div class="row search-party-results">
          <portrait class="col-desktop-5 col-tablet-4 col-mobile-6" ng-repeat="party in ::parties"></portrait>
        </div>
        <div class="search-results-showall" ng-if="::!!volumes" ng-click="searchParties()">show all {{::parties.count}} users</div>
      </div>

      <div class="search-results-section" ng-if="::!!volumes">
        <h3>
          Volumes
          <button class="mini small" ng-if="::!!parties" ng-click="searchVolumes()">show all {{::volumes.count}}</button>
          <small ng-if="::!parties">{{::volumes.count}} total</small>
        </h3>
        
        <ul class="row search-volume-results">
          <li ng-repeat="volume in ::volumes">
            <h1 class="search-volume-result-title">
              <span ng-if="expanded.volume !== volume" ng-click="expandVolume(volume)" class="icon radio"></span>
              <span ng-if="expanded.volume === volume" ng-click="expandVolume()" class="icon radio-selected"></span>
              <a ng-href="{{::volume.route()}}" ng-bind="::volume.name"></a>
            </h1>

            <div class="volume-list-investigators">
              <volume-owners></volume-owners>
            </div>

            <div class="volume-list-body" ng-bind="::volume.body | truncate:200"></div>
            <div ng-if="expanded.volume === volume && !!volume.excerpts">
              <volume-excerpts></volume-excerpts>
            </div>
          </li>
        </ul>
        <div class="search-results-showall" ng-if="::!!parties" ng-click="searchVolumes()">show all {{::volumes.count}} volumes</div>
      </div>

      <div class="search-pages" ng-if="::count">
        <span ng-if="::pageCurrent != 1">
          <a ng-click="searchPage(1)">1</a> <a ng-click="searchPage(pageCurrent-1)">&lt;</a> 
        </span>
        <input type="number" ng-model="pageCurrent" key-enter="searchPage(pageCurrent)"/>
        <span ng-if="::pageCurrent != pageCount">
          <a ng-click="searchPage(pageCurrent+1)">&gt;</a> <a ng-click="searchPage(pageCount)" ng-bind="::pageCount"></a>
        </span>
      </div>
    </div>
    </ng-form>
  </div>
</article>
