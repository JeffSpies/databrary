<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Controller/Register.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE OverloadedStrings #-}</span>
<a name="line-2"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Controller</span><span class='hs-varop'>.</span><span class='hs-conid'>Register</span>
<a name="line-3"></a>  <span class='hs-layout'>(</span> <span class='hs-varid'>passwordResetHandler</span>
<a name="line-4"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>viewPasswordReset</span>
<a name="line-5"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>postPasswordReset</span>
<a name="line-6"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>registerHandler</span>
<a name="line-7"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>viewRegister</span>
<a name="line-8"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>postRegister</span>
<a name="line-9"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>resendInvestigatorHandler</span>
<a name="line-10"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>resendInvestigator</span>
<a name="line-11"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>&lt;$&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>BS</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-varop'>.</span><span class='hs-conid'>Builder</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>BSB</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-varop'>.</span><span class='hs-conid'>Char8</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>BSC</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Monoid</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>&lt;&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>T</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>Encoding</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TE</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>Lazy</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TL</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>Lazy</span><span class='hs-varop'>.</span><span class='hs-conid'>Encoding</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TLE</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Network</span><span class='hs-varop'>.</span><span class='hs-conid'>HTTP</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span><span class='hs-varop'>.</span><span class='hs-conid'>Method</span> <span class='hs-layout'>(</span><span class='hs-varid'>methodGet</span><span class='hs-layout'>,</span> <span class='hs-varid'>methodPost</span><span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Network</span><span class='hs-varop'>.</span><span class='hs-conid'>HTTP</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span><span class='hs-varop'>.</span><span class='hs-conid'>Method</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>HTM</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Servant</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromHttpApiData</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ops</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Has</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Service</span><span class='hs-varop'>.</span><span class='hs-conid'>Mail</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Static</span><span class='hs-varop'>.</span><span class='hs-conid'>Fillin</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Model</span><span class='hs-varop'>.</span><span class='hs-conid'>Permission</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Model</span><span class='hs-varop'>.</span><span class='hs-conid'>Id</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Model</span><span class='hs-varop'>.</span><span class='hs-conid'>Party</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Model</span><span class='hs-varop'>.</span><span class='hs-conid'>Identity</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Model</span><span class='hs-varop'>.</span><span class='hs-conid'>Token</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HTTP</span><span class='hs-varop'>.</span><span class='hs-conid'>Form</span><span class='hs-varop'>.</span><span class='hs-conid'>Deform</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HTTP</span><span class='hs-varop'>.</span><span class='hs-conid'>Path</span><span class='hs-varop'>.</span><span class='hs-conid'>Parser</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Action</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Controller</span><span class='hs-varop'>.</span><span class='hs-conid'>Paths</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Controller</span><span class='hs-varop'>.</span><span class='hs-conid'>Form</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Controller</span><span class='hs-varop'>.</span><span class='hs-conid'>Permission</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Controller</span><span class='hs-varop'>.</span><span class='hs-conid'>Party</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Controller</span><span class='hs-varop'>.</span><span class='hs-conid'>Token</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Controller</span><span class='hs-varop'>.</span><span class='hs-conid'>Angular</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>View</span><span class='hs-varop'>.</span><span class='hs-conid'>Register</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="resetPasswordMail"></a><span class='hs-definition'>resetPasswordMail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>BS</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span> <span class='hs-conid'>SiteAuth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TL</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TL</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handler</span> <span class='hs-conid'>()</span>
<a name="line-47"></a><span class='hs-definition'>resetPasswordMail</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>email</span><span class='hs-layout'>)</span> <span class='hs-varid'>subj</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span>
<a name="line-48"></a>  <span class='hs-varid'>sendMail</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Left</span> <span class='hs-varid'>email</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>subj</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-definition'>resetPasswordMail</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>auth</span><span class='hs-layout'>)</span> <span class='hs-varid'>subj</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-50"></a>  <span class='hs-varid'>tok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loginTokenId</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>createLoginToken</span> <span class='hs-varid'>auth</span> <span class='hs-conid'>True</span>
<a name="line-51"></a>  <span class='hs-varid'>req</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>peek</span>
<a name="line-52"></a>  <span class='hs-varid'>sendMail</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Right</span> <span class='hs-varop'>$</span> <span class='hs-varid'>view</span> <span class='hs-varid'>auth</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>subj</span>
<a name="line-53"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TLE</span><span class='hs-varop'>.</span><span class='hs-varid'>decodeLatin1</span> <span class='hs-varop'>$</span> <span class='hs-conid'>BSB</span><span class='hs-varop'>.</span><span class='hs-varid'>toLazyByteString</span> <span class='hs-varop'>$</span> <span class='hs-varid'>actionURL</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>req</span><span class='hs-layout'>)</span> <span class='hs-varid'>viewLoginToken</span> <span class='hs-layout'>(</span><span class='hs-conid'>HTML</span><span class='hs-layout'>,</span> <span class='hs-varid'>tok</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="registerHandler"></a><span class='hs-definition'>registerHandler</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>API</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HTM</span><span class='hs-varop'>.</span><span class='hs-conid'>Method</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>BS</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-conid'>BS</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Action</span>
<a name="line-56"></a><span class='hs-definition'>registerHandler</span> <span class='hs-varid'>api</span> <span class='hs-varid'>method</span> <span class='hs-keyword'>_</span>
<a name="line-57"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>method</span> <span class='hs-varop'>==</span> <span class='hs-varid'>methodGet</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>api</span> <span class='hs-varop'>==</span> <span class='hs-conid'>HTML</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>viewRegisterAction</span>
<a name="line-58"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>method</span> <span class='hs-varop'>==</span> <span class='hs-varid'>methodPost</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>postRegisterAction</span> <span class='hs-varid'>api</span>
<a name="line-59"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"unhandled api/method combo"</span> <span class='hs-comment'>-- TODO: better error</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="viewRegister"></a><span class='hs-definition'>viewRegister</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ActionRoute</span> <span class='hs-conid'>()</span>
<a name="line-62"></a><span class='hs-definition'>viewRegister</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>action</span> <span class='hs-conid'>GET</span> <span class='hs-layout'>(</span><span class='hs-varid'>pathHTML</span> <span class='hs-varop'>&lt;/&lt;</span> <span class='hs-str'>"user"</span> <span class='hs-varop'>&lt;/&lt;</span> <span class='hs-str'>"register"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>viewRegisterAction</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="viewRegisterAction"></a><span class='hs-definition'>viewRegisterAction</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Action</span>
<a name="line-65"></a><span class='hs-definition'>viewRegisterAction</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withAuth</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-66"></a>  <span class='hs-varid'>angular</span>
<a name="line-67"></a>  <span class='hs-varid'>maybeIdentity</span>
<a name="line-68"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>peeks</span> <span class='hs-varop'>$</span> <span class='hs-varid'>blankForm</span> <span class='hs-varop'>.</span> <span class='hs-varid'>htmlRegister</span><span class='hs-layout'>)</span>
<a name="line-69"></a>    <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>peeks</span> <span class='hs-varop'>$</span> <span class='hs-varid'>otherRouteResponse</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>viewParty</span> <span class='hs-layout'>(</span><span class='hs-conid'>HTML</span><span class='hs-layout'>,</span> <span class='hs-conid'>TargetProfile</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="postRegister"></a><span class='hs-definition'>postRegister</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ActionRoute</span> <span class='hs-conid'>API</span>
<a name="line-72"></a><span class='hs-definition'>postRegister</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>action</span> <span class='hs-conid'>POST</span> <span class='hs-layout'>(</span><span class='hs-varid'>pathAPI</span> <span class='hs-varop'>&lt;/&lt;</span> <span class='hs-str'>"user"</span> <span class='hs-varop'>&lt;/&lt;</span> <span class='hs-str'>"register"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>postRegisterAction</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="RegisterRequest"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>RegisterRequest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RegisterRequest</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span> <span class='hs-conid'>BSC</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span> <span class='hs-conid'>Bool</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="postRegisterAction"></a><span class='hs-definition'>postRegisterAction</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>API</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Action</span>
<a name="line-77"></a><span class='hs-definition'>postRegisterAction</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>api</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>withoutAuth</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-78"></a>  <span class='hs-varid'>reg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runForm</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>api</span> <span class='hs-varop'>==</span> <span class='hs-conid'>HTML</span><span class='hs-layout'>)</span> <span class='hs-varop'>`thenUse`</span> <span class='hs-varid'>htmlRegister</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-79"></a>    <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-str'>"sortname"</span> <span class='hs-varop'>.:&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>deformRequired</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>deform</span><span class='hs-layout'>)</span>
<a name="line-80"></a>    <span class='hs-varid'>prename</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-str'>"prename"</span> <span class='hs-varop'>.:&gt;</span> <span class='hs-varid'>deformNonEmpty</span> <span class='hs-varid'>deform</span>
<a name="line-81"></a>    <span class='hs-varid'>email</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-str'>"email"</span> <span class='hs-varop'>.:&gt;</span> <span class='hs-varid'>emailTextForm</span>
<a name="line-82"></a>    <span class='hs-varid'>affiliation</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-str'>"affiliation"</span> <span class='hs-varop'>.:&gt;</span> <span class='hs-varid'>deformNonEmpty</span> <span class='hs-varid'>deform</span>
<a name="line-83"></a>    <span class='hs-varid'>agreement</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-str'>"agreement"</span> <span class='hs-varop'>.:&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>deformCheck</span> <span class='hs-str'>"You must consent to the user agreement."</span> <span class='hs-varid'>id</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>deform</span><span class='hs-layout'>)</span>
<a name="line-84"></a>    <span class='hs-keyword'>let</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RegisterRequest</span> <span class='hs-varid'>name</span> <span class='hs-varid'>prename</span> <span class='hs-varid'>email</span> <span class='hs-varid'>affiliation</span> <span class='hs-varid'>agreement</span>
<a name="line-85"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blankParty</span>
<a name="line-86"></a>          <span class='hs-layout'>{</span> <span class='hs-varid'>partyRow</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>partyRow</span> <span class='hs-varid'>blankParty</span><span class='hs-layout'>)</span>
<a name="line-87"></a>            <span class='hs-layout'>{</span> <span class='hs-varid'>partySortName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-88"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>partyPreName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prename</span>
<a name="line-89"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>partyAffiliation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>affiliation</span>
<a name="line-90"></a>            <span class='hs-layout'>}</span>
<a name="line-91"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>partyAccount</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>a</span>
<a name="line-92"></a>          <span class='hs-layout'>}</span>
<a name="line-93"></a>        <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Account</span>
<a name="line-94"></a>          <span class='hs-layout'>{</span> <span class='hs-varid'>accountParty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-95"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>accountEmail</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>email</span>
<a name="line-96"></a>          <span class='hs-layout'>}</span>
<a name="line-97"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>a</span>
<a name="line-98"></a>  <span class='hs-varid'>auth</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>SiteAuth</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>addAccount</span> <span class='hs-varid'>reg</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>Nothing</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>mempty</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>lookupSiteAuthByEmail</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>accountEmail</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span>
<a name="line-99"></a>  <span class='hs-varid'>resetPasswordMail</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>auth</span><span class='hs-layout'>)</span>
<a name="line-100"></a>    <span class='hs-str'>"Databrary account created"</span>
<a name="line-101"></a>    <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>url</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-102"></a>      <span class='hs-str'>"Thank you for registering with  Please use this link to complete your registration:\n\n"</span>
<a name="line-103"></a>      <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>url</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-str'>"\n\n\
<a name="line-104"></a>      \By clicking the above link, you also indicate that you have read and understand the Databrary Access agreement, which you can download here: http://databrary.org/policies/agreement.pdf\n\n\
<a name="line-105"></a>      \Once you've validated your e-mail, you will be able to request authorization to be granted full access to \n"</span>
<a name="line-106"></a>  <span class='hs-varid'>focusIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>staticSendInvestigator</span> <span class='hs-layout'>(</span><span class='hs-varid'>view</span> <span class='hs-varid'>auth</span><span class='hs-layout'>)</span>
<a name="line-107"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>okResponse</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Your confirmation email has been sent to '"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>accountEmail</span> <span class='hs-varid'>reg</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-str'>"'."</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="resendInvestigator"></a><span class='hs-definition'>resendInvestigator</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ActionRoute</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span> <span class='hs-conid'>Party</span><span class='hs-layout'>)</span>
<a name="line-110"></a><span class='hs-definition'>resendInvestigator</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>action</span> <span class='hs-conid'>POST</span> <span class='hs-layout'>(</span><span class='hs-varid'>pathHTML</span> <span class='hs-varop'>&gt;/&gt;</span> <span class='hs-varid'>pathId</span> <span class='hs-varop'>&lt;/&lt;</span> <span class='hs-str'>"investigator"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-111"></a>    <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>resendInvestigatorHandler</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-str'>"partyId"</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>BSC</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varop'>.</span> <span class='hs-varid'>show</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-112"></a>
<a name="line-113"></a><a name="resendInvestigatorHandler"></a><span class='hs-definition'>resendInvestigatorHandler</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>BS</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-conid'>BS</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Action</span>
<a name="line-114"></a><span class='hs-definition'>resendInvestigatorHandler</span> <span class='hs-varid'>params</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withAuth</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>  <span class='hs-comment'>-- TODO: handle POST only</span>
<a name="line-115"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>paramId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>error</span> <span class='hs-str'>"partyId missing"</span><span class='hs-layout'>)</span> <span class='hs-conid'>TE</span><span class='hs-varop'>.</span><span class='hs-varid'>decodeUtf8</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup</span> <span class='hs-str'>"partyId"</span> <span class='hs-varid'>params</span><span class='hs-layout'>)</span>
<a name="line-116"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>either</span> <span class='hs-layout'>(</span><span class='hs-varid'>error</span> <span class='hs-varop'>.</span> <span class='hs-varid'>show</span><span class='hs-layout'>)</span> <span class='hs-conid'>Id</span> <span class='hs-layout'>(</span><span class='hs-varid'>parseUrlPiece</span> <span class='hs-varid'>paramId</span><span class='hs-layout'>)</span>
<a name="line-117"></a>  <span class='hs-varid'>checkMemberADMIN</span>
<a name="line-118"></a>  <span class='hs-varid'>p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getParty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>PermissionREAD</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TargetParty</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-119"></a>  <span class='hs-varid'>focusIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>staticSendInvestigator</span> <span class='hs-varid'>p</span>
<a name="line-120"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>okResponse</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-str'>"sent"</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-121"></a>
<a name="line-122"></a><a name="passwordResetHandler"></a><span class='hs-definition'>passwordResetHandler</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>API</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HTM</span><span class='hs-varop'>.</span><span class='hs-conid'>Method</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>BS</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-conid'>BS</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Action</span>
<a name="line-123"></a><span class='hs-definition'>passwordResetHandler</span> <span class='hs-varid'>api</span> <span class='hs-varid'>method</span> <span class='hs-keyword'>_</span>
<a name="line-124"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>method</span> <span class='hs-varop'>==</span> <span class='hs-varid'>methodGet</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>api</span> <span class='hs-varop'>==</span> <span class='hs-conid'>HTML</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>viewPasswordResetAction</span>
<a name="line-125"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>method</span> <span class='hs-varop'>==</span> <span class='hs-varid'>methodPost</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>postPasswordResetAction</span> <span class='hs-varid'>api</span>
<a name="line-126"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"unhandled api/method combo"</span> <span class='hs-comment'>-- TODO: better error</span>
<a name="line-127"></a>
<a name="line-128"></a><a name="viewPasswordReset"></a><span class='hs-definition'>viewPasswordReset</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ActionRoute</span> <span class='hs-conid'>()</span>
<a name="line-129"></a><span class='hs-definition'>viewPasswordReset</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>action</span> <span class='hs-conid'>GET</span> <span class='hs-layout'>(</span><span class='hs-varid'>pathHTML</span> <span class='hs-varop'>&lt;/&lt;</span> <span class='hs-str'>"user"</span> <span class='hs-varop'>&lt;/&lt;</span> <span class='hs-str'>"password"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>viewPasswordResetAction</span>
<a name="line-130"></a>
<a name="line-131"></a><a name="viewPasswordResetAction"></a><span class='hs-definition'>viewPasswordResetAction</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Action</span>
<a name="line-132"></a><span class='hs-definition'>viewPasswordResetAction</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withoutAuth</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-133"></a>  <span class='hs-varid'>angular</span>
<a name="line-134"></a>  <span class='hs-varid'>peeks</span> <span class='hs-varop'>$</span> <span class='hs-varid'>blankForm</span> <span class='hs-varop'>.</span> <span class='hs-varid'>htmlPasswordReset</span>
<a name="line-135"></a>
<a name="line-136"></a><a name="postPasswordReset"></a><span class='hs-definition'>postPasswordReset</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ActionRoute</span> <span class='hs-conid'>API</span>
<a name="line-137"></a><span class='hs-definition'>postPasswordReset</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>action</span> <span class='hs-conid'>POST</span> <span class='hs-layout'>(</span><span class='hs-varid'>pathAPI</span> <span class='hs-varop'>&lt;/&lt;</span> <span class='hs-str'>"user"</span> <span class='hs-varop'>&lt;/&lt;</span> <span class='hs-str'>"password"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>postPasswordResetAction</span>
<a name="line-138"></a>
<a name="line-139"></a><a name="PasswordResetRequest"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PasswordResetRequest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PasswordResetRequest</span> <span class='hs-conid'>BSC</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span>
<a name="line-140"></a>
<a name="line-141"></a><a name="postPasswordResetAction"></a><span class='hs-definition'>postPasswordResetAction</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>API</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Action</span>
<a name="line-142"></a><span class='hs-definition'>postPasswordResetAction</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>api</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>withoutAuth</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-143"></a>  <span class='hs-conid'>PasswordResetRequest</span> <span class='hs-varid'>email</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runForm</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>api</span> <span class='hs-varop'>==</span> <span class='hs-conid'>HTML</span><span class='hs-layout'>)</span> <span class='hs-varop'>`thenUse`</span> <span class='hs-varid'>htmlPasswordReset</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-144"></a>    <span class='hs-conid'>PasswordResetRequest</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-str'>"email"</span> <span class='hs-varop'>.:&gt;</span> <span class='hs-varid'>emailTextForm</span><span class='hs-layout'>)</span>
<a name="line-145"></a>  <span class='hs-varid'>auth</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupPasswordResetAccount</span> <span class='hs-varid'>email</span>
<a name="line-146"></a>  <span class='hs-varid'>resetPasswordMail</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>email</span><span class='hs-layout'>)</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>auth</span><span class='hs-layout'>)</span>
<a name="line-147"></a>    <span class='hs-str'>"Databrary password reset"</span> <span class='hs-varop'>$</span>
<a name="line-148"></a>    <span class='hs-layout'>(</span><span class='hs-str'>"Someone (hopefully you) has requested to reset the password for the Databrary account associated with this email address. If you did not request this, let us know (by replying to this message) or simply ignore it.\n\n"</span> <span class='hs-varop'>&lt;&gt;</span><span class='hs-layout'>)</span>
<a name="line-149"></a>    <span class='hs-varop'>.</span> <span class='hs-varid'>maybe</span>
<a name="line-150"></a>      <span class='hs-str'>"Unfortunately, no Databrary account was found for this email address. You can try again with a different email address, or reply to this email for assistance.\n"</span>
<a name="line-151"></a>      <span class='hs-layout'>(</span><span class='hs-str'>"Otherwise, you may use this link to reset your Databrary password:\n\n"</span> <span class='hs-varop'>&lt;&gt;</span><span class='hs-layout'>)</span>
<a name="line-152"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>okResponse</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Your password reset information has been sent to '"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>email</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-str'>"'."</span>
<a name="line-153"></a>
</pre></body>
</html>
