<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE OverloadedStrings #-}
<span class="lineno">    2 </span>module Databrary.HTTP.Request
<span class="lineno">    3 </span>  ( Wai.Request
<span class="lineno">    4 </span>  , MonadHasRequest
<span class="lineno">    5 </span>  , lookupRequestHeader
<span class="lineno">    6 </span>  , lookupRequestHeaders
<span class="lineno">    7 </span>  , lookupQueryParameters
<span class="lineno">    8 </span>  , boolParameterValue
<span class="lineno">    9 </span>  , boolQueryParameter
<span class="lineno">   10 </span>  , requestHost
<span class="lineno">   11 </span>  , requestURI
<span class="lineno">   12 </span>  ) where
<span class="lineno">   13 </span>
<span class="lineno">   14 </span>import qualified Data.ByteString as BS
<span class="lineno">   15 </span>import qualified Data.ByteString.Char8 as BSC
<span class="lineno">   16 </span>import Data.Maybe (fromMaybe)
<span class="lineno">   17 </span>import Data.Monoid ((&lt;&gt;))
<span class="lineno">   18 </span>import Network.HTTP.Types (HeaderName)
<span class="lineno">   19 </span>import Network.URI (URI(..), URIAuth(..))
<span class="lineno">   20 </span>import qualified Network.Wai as Wai
<span class="lineno">   21 </span>
<span class="lineno">   22 </span>import Databrary.Has (MonadHas)
<span class="lineno">   23 </span>
<span class="lineno">   24 </span>type MonadHasRequest c m = MonadHas Wai.Request c m
<span class="lineno">   25 </span>
<span class="lineno">   26 </span>lookupRequestHeader :: HeaderName -&gt; Wai.Request -&gt; Maybe BS.ByteString
<span class="lineno">   27 </span><span class="decl"><span class="istickedoff">lookupRequestHeader h = lookup h . Wai.requestHeaders</span></span>
<span class="lineno">   28 </span>
<span class="lineno">   29 </span>lookupRequestHeaders :: HeaderName -&gt; Wai.Request -&gt; [BS.ByteString]
<span class="lineno">   30 </span><span class="decl"><span class="istickedoff">lookupRequestHeaders h = map <span class="nottickedoff">snd</span> . filter <span class="nottickedoff">((h ==) . fst)</span> . Wai.requestHeaders</span></span>
<span class="lineno">   31 </span>
<span class="lineno">   32 </span>lookupQueryParameters :: BS.ByteString -&gt; Wai.Request -&gt; [Maybe BS.ByteString]
<span class="lineno">   33 </span><span class="decl"><span class="istickedoff">lookupQueryParameters q = map snd . filter ((q ==) . fst) . Wai.queryString</span></span>
<span class="lineno">   34 </span>
<span class="lineno">   35 </span>boolValue :: BS.ByteString -&gt; Bool
<span class="lineno">   36 </span><span class="decl"><span class="istickedoff">boolValue &quot;0&quot; = False</span>
<span class="lineno">   37 </span><span class="spaces"></span><span class="istickedoff">boolValue &quot;false&quot; = <span class="nottickedoff">False</span></span>
<span class="lineno">   38 </span><span class="spaces"></span><span class="istickedoff">boolValue &quot;off&quot; = <span class="nottickedoff">False</span></span>
<span class="lineno">   39 </span><span class="spaces"></span><span class="istickedoff">boolValue &quot;&quot; = <span class="nottickedoff">False</span></span>
<span class="lineno">   40 </span><span class="spaces"></span><span class="istickedoff">boolValue _ = True</span></span>
<span class="lineno">   41 </span>
<span class="lineno">   42 </span>boolParameterValue :: Maybe BS.ByteString -&gt; Bool
<span class="lineno">   43 </span><span class="decl"><span class="istickedoff">boolParameterValue = all boolValue</span></span>
<span class="lineno">   44 </span>
<span class="lineno">   45 </span>boolQueryParameter :: BS.ByteString -&gt; Wai.Request -&gt; Bool
<span class="lineno">   46 </span><span class="decl"><span class="istickedoff">boolQueryParameter q = any <span class="nottickedoff">boolParameterValue</span> . lookupQueryParameters <span class="nottickedoff">q</span></span></span>
<span class="lineno">   47 </span>
<span class="lineno">   48 </span>defaultHost :: BS.ByteString
<span class="lineno">   49 </span><span class="decl"><span class="istickedoff">defaultHost = &quot;databrary.org&quot;</span></span>
<span class="lineno">   50 </span>
<span class="lineno">   51 </span>requestHost :: Wai.Request -&gt; BS.ByteString
<span class="lineno">   52 </span><span class="decl"><span class="istickedoff">requestHost req =</span>
<span class="lineno">   53 </span><span class="spaces">  </span><span class="istickedoff">(if Wai.isSecure req then &quot;https://&quot; else &quot;http://&quot;)</span>
<span class="lineno">   54 </span><span class="spaces">  </span><span class="istickedoff">&lt;&gt; fromMaybe &quot;databrary.org&quot; (Wai.requestHeaderHost req)</span></span>
<span class="lineno">   55 </span>
<span class="lineno">   56 </span>requestURI :: Wai.Request -&gt; URI
<span class="lineno">   57 </span><span class="decl"><span class="istickedoff">requestURI req = URI</span>
<span class="lineno">   58 </span><span class="spaces">  </span><span class="istickedoff">{ uriScheme = if <span class="tickonlyfalse">Wai.isSecure req</span> then <span class="nottickedoff">&quot;https:&quot;</span> else &quot;http:&quot;</span>
<span class="lineno">   59 </span><span class="spaces">  </span><span class="istickedoff">, uriAuthority = Just URIAuth</span>
<span class="lineno">   60 </span><span class="spaces">    </span><span class="istickedoff">{ uriUserInfo = &quot;&quot;</span>
<span class="lineno">   61 </span><span class="spaces">    </span><span class="istickedoff">, uriRegName = BSC.unpack $ fromMaybe defaultHost $ Wai.requestHeaderHost req</span>
<span class="lineno">   62 </span><span class="spaces">    </span><span class="istickedoff">, uriPort = &quot;&quot;</span>
<span class="lineno">   63 </span><span class="spaces">    </span><span class="istickedoff">}</span>
<span class="lineno">   64 </span><span class="spaces">  </span><span class="istickedoff">, uriPath = BSC.unpack $ Wai.rawPathInfo req</span>
<span class="lineno">   65 </span><span class="spaces">  </span><span class="istickedoff">, uriQuery = BSC.unpack $ Wai.rawQueryString req</span>
<span class="lineno">   66 </span><span class="spaces">  </span><span class="istickedoff">, uriFragment = &quot;&quot;</span>
<span class="lineno">   67 </span><span class="spaces">  </span><span class="istickedoff">}</span></span>

</pre>
</body>
</html>
