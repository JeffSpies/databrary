<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE OverloadedStrings, RecordWildCards #-}
<span class="lineno">    2 </span>module View.Notification
<span class="lineno">    3 </span>  ( mailNotifications
<span class="lineno">    4 </span>  , htmlNotification
<span class="lineno">    5 </span>  ) where
<span class="lineno">    6 </span>
<span class="lineno">    7 </span>import Control.Arrow (second)
<span class="lineno">    8 </span>import qualified Data.ByteString.Builder as BSB
<span class="lineno">    9 </span>import qualified Data.ByteString.Char8 as BSC
<span class="lineno">   10 </span>import Data.Function (on)
<span class="lineno">   11 </span>import Data.Maybe (fromMaybe, isJust)
<span class="lineno">   12 </span>import Data.Monoid ((&lt;&gt;))
<span class="lineno">   13 </span>import qualified Data.Text.Encoding as TE
<span class="lineno">   14 </span>import qualified Data.Text.Lazy as TL
<span class="lineno">   15 </span>import qualified Data.Text.Lazy.Encoding as TLE
<span class="lineno">   16 </span>import qualified Text.Blaze.Html5 as H
<span class="lineno">   17 </span>import qualified Text.Blaze.Html5.Attributes as HA
<span class="lineno">   18 </span>
<span class="lineno">   19 </span>import Ops
<span class="lineno">   20 </span>import Model.Permission
<span class="lineno">   21 </span>import Model.Id.Types
<span class="lineno">   22 </span>import Model.Party
<span class="lineno">   23 </span>import Model.Volume.Types
<span class="lineno">   24 </span>import Model.Segment
<span class="lineno">   25 </span>import Model.Slot.Types
<span class="lineno">   26 </span>import Model.Tag.Types
<span class="lineno">   27 </span>import Model.Notification
<span class="lineno">   28 </span>import Service.Messages
<span class="lineno">   29 </span>import HTTP.Route
<span class="lineno">   30 </span>import Action.Route
<span class="lineno">   31 </span>import Controller.Paths
<span class="lineno">   32 </span>import {-# SOURCE #-} Controller.Party
<span class="lineno">   33 </span>import {-# SOURCE #-} Controller.Volume
<span class="lineno">   34 </span>import {-# SOURCE #-} Controller.Slot
<span class="lineno">   35 </span>import {-# SOURCE #-} Controller.AssetSegment
<span class="lineno">   36 </span>import View.Authorize (authorizeSiteTitle)
<span class="lineno">   37 </span>import View.Party (htmlPartyViewLink)
<span class="lineno">   38 </span>import View.Volume (htmlVolumeViewLink)
<span class="lineno">   39 </span>import View.VolumeAccess (volumeAccessTitle, volumeAccessPresetTitle)
<span class="lineno">   40 </span>import View.Container (releaseTitle)
<span class="lineno">   41 </span>import View.Html
<span class="lineno">   42 </span>
<span class="lineno">   43 </span>mailLink :: Route r a -&gt; a -&gt; [(BSC.ByteString, BSC.ByteString)] -&gt; TL.Text
<span class="lineno">   44 </span><span class="decl"><span class="istickedoff">mailLink u a q = TLE.decodeLatin1 $ BSB.toLazyByteString $ &quot;https://databrary.org&quot; &lt;&gt; actionURL Nothing u a (map (second Just) q :: Query)</span></span>
<span class="lineno">   45 </span>
<span class="lineno">   46 </span>partyEditLink :: (ActionRoute PartyTarget -&gt; PartyTarget -&gt; t) -&gt; PartyRow -&gt; PartyRow -&gt; t
<span class="lineno">   47 </span><span class="decl"><span class="istickedoff">partyEditLink link target p = link viewPartyEdit (if <span class="tickonlytrue">on (==) partyId p target</span> then TargetProfile else <span class="nottickedoff">TargetParty (partyId p)</span>)</span></span>
<span class="lineno">   48 </span>
<span class="lineno">   49 </span>mailNotification :: Messages -&gt; Notification -&gt; TL.Text
<span class="lineno">   50 </span><span class="decl"><span class="istickedoff">mailNotification msg Notification{..} = case notificationNotice of</span>
<span class="lineno">   51 </span><span class="spaces">  </span><span class="istickedoff">NoticeAccountChange -&gt;</span>
<span class="lineno">   52 </span><span class="spaces">    </span><span class="istickedoff">party'S &lt;&gt; &quot; email or password has been changed. If you made this change, you may ignore this email. To review or update your account information, go to: &quot;</span>
<span class="lineno">   53 </span><span class="spaces">    </span><span class="istickedoff">&lt;&gt; partyEdit (fromMaybe <span class="nottickedoff">target</span> notificationParty) [(&quot;page&quot;, &quot;account&quot;)]</span>
<span class="lineno">   54 </span><span class="spaces">    </span><span class="istickedoff">&lt;&gt; &quot;\nIf you did not make this change, please contact us immediately.&quot;</span>
<span class="lineno">   55 </span><span class="spaces">  </span><span class="istickedoff">NoticeAuthorizeRequest -&gt;</span>
<span class="lineno">   56 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; requested authorization from &quot; &lt;&gt; party &lt;&gt; &quot;. To review the status of this request, go to: &quot;</span></span>
<span class="lineno">   57 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; partyEdit target [(&quot;page&quot;, &quot;apply&quot;), partyq]</span></span>
<span class="lineno">   58 </span><span class="spaces">  </span><span class="istickedoff">NoticeAuthorizeGranted</span>
<span class="lineno">   59 </span><span class="spaces">    </span><span class="istickedoff">| Just p &lt;- <span class="nottickedoff">notificationPermission</span> -&gt;</span>
<span class="lineno">   60 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">&quot;You have been authorized under &quot; &lt;&gt; party &lt;&gt; &quot;, &quot;</span></span>
<span class="lineno">   61 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; if p == PermissionNONE then &quot;for group/lab-only access.&quot;</span></span>
<span class="lineno">   62 </span><span class="spaces">         </span><span class="istickedoff"><span class="nottickedoff">else &quot;as a Databrary &quot; &lt;&gt; TL.fromStrict (authorizeSiteTitle p msg) &lt;&gt; &quot;. \</span></span>
<span class="lineno">   63 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\Your authorization allows you to access all the shared data in  \</span></span>
<span class="lineno">   64 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\Our primary goal is to inspire you to reuse shared videos on Databrary to ask new questions outside the scope of the original study. \</span></span>
<span class="lineno">   65 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\You will also find illustrative video excerpts that you can use for teaching and to learn about other researchers' methods and procedures.\</span></span>
<span class="lineno">   66 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\\n\n\</span></span>
<span class="lineno">   67 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\Databrary's unique \&quot;active curation\&quot; functionality allows you to upload your videos as you collect them so that your data are backed up and preserved in our free, secure library, your videos are immediately available to you and your collaborators offsite, and your data are organized and ready for sharing. \</span></span>
<span class="lineno">   68 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\Your data will remain private and accessible only to your lab members and collaborators until you are ready to share with the Databrary community. \</span></span>
<span class="lineno">   69 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\When you are ready, sharing is as easy as clicking a button!\</span></span>
<span class="lineno">   70 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\\n\n\</span></span>
<span class="lineno">   71 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\You can use our template Databrary release form to obtain permission for sharing the data you collect from your participants, which can be found here: http://databrary.org/access/policies/release-template.html.\n\</span></span>
<span class="lineno">   72 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\The release form can be added to new or existing IRB protocols. \</span></span>
<span class="lineno">   73 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\It is completely adaptable and can be customized to suit your needs. \</span></span>
<span class="lineno">   74 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\We also offer additional information and helpful tips about managing and sharing your video data in our User Guide: http://databrary.org/access/guide. \</span></span>
<span class="lineno">   75 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\Information about downloading data from Databrary and other useful instructions can be found in the Frequently Asked Questions: https://www.databrary.org/resources/faq.html.\n\</span></span>
<span class="lineno">   76 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\As soon as your protocol is amended to allow you to share data, you can start uploading your data from each new session. \</span></span>
<span class="lineno">   77 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\Don't wait until your study is complete to upload your videos. \</span></span>
<span class="lineno">   78 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\It's much easier to upload data after each data collection while your study is in progress!\</span></span>
<span class="lineno">   79 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\\n\n\</span></span>
<span class="lineno">   80 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\We are dedicated to providing assistance to the Databrary community. \</span></span>
<span class="lineno">   81 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\Please contact us at support@databrary.org with questions or for help getting started.\</span></span>
<span class="lineno">   82 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">\\n&quot;</span></span>
<span class="lineno">   83 </span><span class="spaces">    </span><span class="istickedoff">| <span class="nottickedoff">otherwise</span> -&gt;</span>
<span class="lineno">   84 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">&quot;Your authorization under &quot; &lt;&gt; party &lt;&gt; &quot; has been revoked. To review and apply for authorizations, go to: &quot;</span></span>
<span class="lineno">   85 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; partyEdit target [(&quot;page&quot;, &quot;apply&quot;)]</span></span>
<span class="lineno">   86 </span><span class="spaces">  </span><span class="istickedoff">NoticeAuthorizeExpiring -&gt;</span>
<span class="lineno">   87 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&quot;Your authorization under &quot; &lt;&gt; party &lt;&gt; &quot; will expire within a week. Please contact them and request that they renew your authorization.&quot;</span></span>
<span class="lineno">   88 </span><span class="spaces">  </span><span class="istickedoff">NoticeAuthorizeExpired -&gt;</span>
<span class="lineno">   89 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&quot;Your authorization under &quot; &lt;&gt; party &lt;&gt; &quot; has expired. Please contact them and request that they renew your authorization.&quot;</span></span>
<span class="lineno">   90 </span><span class="spaces">  </span><span class="istickedoff">NoticeAuthorizeChildRequest -&gt;</span>
<span class="lineno">   91 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; has requested to be authorized through &quot; &lt;&gt; party &lt;&gt; &quot;. To approve or reject this authorization request, go to: &quot;</span></span>
<span class="lineno">   92 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; partyEdit (fromMaybe target notificationParty) [(&quot;page&quot;, &quot;grant&quot;), personq $ Just notificationAgent]</span></span>
<span class="lineno">   93 </span><span class="spaces">  </span><span class="istickedoff">NoticeAuthorizeChildGranted -&gt;</span>
<span class="lineno">   94 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; &quot; &lt;&gt; granted &lt;&gt; &quot; authorization to &quot; &lt;&gt; party &lt;&gt; &quot;. To review this authorization, go to: &quot;</span></span>
<span class="lineno">   95 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; partyEdit target [(&quot;page&quot;, &quot;grant&quot;), partyq]</span></span>
<span class="lineno">   96 </span><span class="spaces">  </span><span class="istickedoff">NoticeAuthorizeChildExpiring -&gt;</span>
<span class="lineno">   97 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">party'S &lt;&gt; &quot; authorization will expire within a week. If you would like to renew their authorization, go to: &quot;</span></span>
<span class="lineno">   98 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; partyEdit target [(&quot;page&quot;, &quot;grant&quot;), partyq]</span></span>
<span class="lineno">   99 </span><span class="spaces">  </span><span class="istickedoff">NoticeAuthorizeChildExpired -&gt;</span>
<span class="lineno">  100 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">party'S &lt;&gt; &quot; authorization has expired. If you would like to renew their authorization, go to: &quot;</span></span>
<span class="lineno">  101 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; partyEdit target [(&quot;page&quot;, &quot;grant&quot;), partyq]</span></span>
<span class="lineno">  102 </span><span class="spaces">  </span><span class="istickedoff">NoticeVolumeAssist -&gt;</span>
<span class="lineno">  103 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; requested assistance with your volume, &quot; &lt;&gt; volume &lt;&gt; &quot;. To review this request, go to: &quot;</span></span>
<span class="lineno">  104 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; volumeEdit [(&quot;page&quot;, &quot;assist&quot;)]</span></span>
<span class="lineno">  105 </span><span class="spaces">  </span><span class="istickedoff">NoticeVolumeCreated -&gt;</span>
<span class="lineno">  106 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; created a volume, &quot; &lt;&gt; volume &lt;&gt; &quot;, on &quot; &lt;&gt; party's &lt;&gt; &quot; behalf. To review this volume, go to: &quot;</span></span>
<span class="lineno">  107 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; mailLink viewVolume (HTML, maybe noId volumeId notificationVolume) []</span></span>
<span class="lineno">  108 </span><span class="spaces">  </span><span class="istickedoff">NoticeVolumeSharing -&gt;</span>
<span class="lineno">  109 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; changed your volume, &quot; &lt;&gt; volume &lt;&gt; &quot;, to &quot; &lt;&gt; TL.fromStrict (volumeAccessPresetTitle (PermissionNONE &lt; perm) msg) &lt;&gt; &quot;. To review this change, go to: &quot;</span></span>
<span class="lineno">  110 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; volumeEdit [(&quot;page&quot;, &quot;access&quot;)]</span></span>
<span class="lineno">  111 </span><span class="spaces">  </span><span class="istickedoff">NoticeVolumeAccessOther -&gt;</span>
<span class="lineno">  112 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; set &quot; &lt;&gt; party's &lt;&gt; &quot; access to &quot; &lt;&gt; TL.fromStrict (volumeAccessTitle perm msg) &lt;&gt; &quot; on your volume, &quot; &lt;&gt; volume &lt;&gt; &quot;. To review this change, go to: &quot;</span></span>
<span class="lineno">  113 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; volumeEdit [(&quot;page&quot;, &quot;access&quot;), partyq]</span></span>
<span class="lineno">  114 </span><span class="spaces">  </span><span class="istickedoff">NoticeVolumeAccess -&gt;</span>
<span class="lineno">  115 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; set &quot; &lt;&gt; party's &lt;&gt; &quot; access to &quot; &lt;&gt; TL.fromStrict (volumeAccessTitle perm msg) &lt;&gt; &quot; on your volume, &quot; &lt;&gt; volume &lt;&gt; &quot;. To review this change, go to: &quot;</span></span>
<span class="lineno">  116 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; volumeEdit [(&quot;page&quot;, &quot;access&quot;)]</span></span>
<span class="lineno">  117 </span><span class="spaces">  </span><span class="istickedoff">NoticeReleaseSlot -&gt;</span>
<span class="lineno">  118 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; set the release level of a folder in &quot; &lt;&gt; volume &lt;&gt; &quot; to &quot; &lt;&gt; TL.fromStrict (releaseTitle notificationRelease msg) &lt;&gt; &quot;. To review this change, go to: &quot;</span></span>
<span class="lineno">  119 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; mailLink (viewSlot False) (HTML, (volumeId &lt;$&gt; notificationVolume, slot)) []</span></span>
<span class="lineno">  120 </span><span class="spaces">  </span><span class="istickedoff">NoticeReleaseAsset -&gt;</span>
<span class="lineno">  121 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; set the release level of a file in your volume (&quot; &lt;&gt; volume &lt;&gt; &quot;) to &quot; &lt;&gt; TL.fromStrict (releaseTitle notificationRelease msg) &lt;&gt; &quot;. To review this change, go to: &quot;</span></span>
<span class="lineno">  122 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; mailLink (viewSlot False) (HTML, (volumeId &lt;$&gt; notificationVolume, slot)) [(&quot;asset&quot;, foldMap (BSC.pack . show) notificationAssetId)]</span></span>
<span class="lineno">  123 </span><span class="spaces">  </span><span class="istickedoff">NoticeReleaseExcerpt -&gt;</span>
<span class="lineno">  124 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; set the release level of a highlight in your volume (&quot; &lt;&gt; volume &lt;&gt; &quot;) to &quot; &lt;&gt; TL.fromStrict (releaseTitle notificationRelease msg) &lt;&gt; &quot;. To review this change, go to: &quot;</span></span>
<span class="lineno">  125 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; assetSegment</span></span>
<span class="lineno">  126 </span><span class="spaces">  </span><span class="istickedoff">NoticeExcerptVolume -&gt;</span>
<span class="lineno">  127 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; created a highlight in your volume (&quot; &lt;&gt; volume &lt;&gt; &quot;). To review this highlight, go to: &quot;</span></span>
<span class="lineno">  128 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; assetSegment</span></span>
<span class="lineno">  129 </span><span class="spaces">  </span><span class="istickedoff">NoticeCommentVolume -&gt;</span>
<span class="lineno">  130 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; commented on your volume (&quot; &lt;&gt; volume &lt;&gt; &quot;). To review or reply, go to: &quot;</span></span>
<span class="lineno">  131 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; slotVolume [] &lt;&gt; &quot;#comment-&quot; &lt;&gt; foldMap (TL.pack . show) notificationCommentId</span></span>
<span class="lineno">  132 </span><span class="spaces">  </span><span class="istickedoff">NoticeCommentReply -&gt; -- high risk information disclosure of volume name</span>
<span class="lineno">  133 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; replied to your comment on the volume, &quot; &lt;&gt; volume &lt;&gt; &quot;. To review or reply, go to: &quot;</span></span>
<span class="lineno">  134 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; slotVolume [] &lt;&gt; &quot;#comment-&quot; &lt;&gt; foldMap (TL.pack . show) notificationCommentId</span></span>
<span class="lineno">  135 </span><span class="spaces">  </span><span class="istickedoff">NoticeTagVolume -&gt;</span>
<span class="lineno">  136 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; tagged the volume, &quot; &lt;&gt; volume &lt;&gt; &quot;, with \&quot;&quot; &lt;&gt; foldMap (TL.fromStrict . TE.decodeLatin1 . tagNameBS . tagName) notificationTag &lt;&gt; &quot;\&quot;. To review tags, go to: &quot;</span></span>
<span class="lineno">  137 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; slotVolume [(&quot;tag&quot;, foldMap (tagNameBS . tagName) notificationTag)] &lt;&gt; &quot;#panel-tags&quot;</span></span>
<span class="lineno">  138 </span><span class="spaces">  </span><span class="istickedoff">NoticeSharedVolume -&gt;</span>
<span class="lineno">  139 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">agent &lt;&gt; &quot; shared the following volume, &quot; &lt;&gt; volume &lt;&gt; &quot;, on  To review, go to: &quot;</span></span>
<span class="lineno">  140 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; mailLink viewVolume (HTML, maybe noId volumeId notificationVolume) []</span></span>
<span class="lineno">  141 </span><span class="spaces">  </span><span class="istickedoff">NoticeNewsletter -&gt;</span>
<span class="lineno">  142 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&quot;A new Databrary newsletter has been posted. Te see it, go to: http://databrary.org/news.html&quot;</span></span>
<span class="lineno">  143 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  144 </span><span class="spaces">  </span><span class="istickedoff">target = partyRow (accountParty notificationTarget)</span>
<span class="lineno">  145 </span><span class="spaces">  </span><span class="istickedoff">person p = (on (/=) partyId p target) `thenUse` <span class="nottickedoff">(TL.fromStrict (partyName p))</span></span>
<span class="lineno">  146 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">agent = fromMaybe &quot;You&quot; $ person notificationAgent</span></span>
<span class="lineno">  147 </span><span class="spaces">  </span><span class="istickedoff">partyp = person =&lt;&lt; notificationParty</span>
<span class="lineno">  148 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">party = fromMaybe &quot;you&quot; partyp</span></span>
<span class="lineno">  149 </span><span class="spaces">  </span><span class="istickedoff">party'sOr your = maybe your <span class="nottickedoff">(&lt;&gt; &quot;'s&quot;)</span> partyp</span>
<span class="lineno">  150 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">party's = party'sOr &quot;your&quot;</span></span>
<span class="lineno">  151 </span><span class="spaces">  </span><span class="istickedoff">party'S = party'sOr &quot;Your&quot;</span>
<span class="lineno">  152 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">personq p = (&quot;party&quot;, maybe &quot;&quot; (BSC.pack . show . partyId) p)</span></span>
<span class="lineno">  153 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">partyq = personq notificationParty</span></span>
<span class="lineno">  154 </span><span class="spaces">  </span><span class="istickedoff">partyEdit = partyEditLink mailLink target</span>
<span class="lineno">  155 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">granted = maybe &quot;revoked&quot; (const &quot;granted&quot;) notificationPermission</span></span>
<span class="lineno">  156 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">volume = maybe &quot;&lt;VOLUME&gt;&quot; (TL.fromStrict . volumeName) notificationVolume</span></span>
<span class="lineno">  157 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">volumeEdit = mailLink viewVolumeEdit (maybe noId volumeId notificationVolume)</span></span>
<span class="lineno">  158 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">perm = fromMaybe PermissionNONE notificationPermission</span></span>
<span class="lineno">  159 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">slot = Id $ SlotId (fromMaybe noId notificationContainerId) (fromMaybe fullSegment notificationSegment)</span></span>
<span class="lineno">  160 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">assetSegment = mailLink (viewAssetSegment False) (HTML, volumeId &lt;$&gt; notificationVolume, slot, fromMaybe noId notificationAssetId) []</span></span>
<span class="lineno">  161 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">slotVolume</span></span>
<span class="lineno">  162 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">| isJust notificationContainerId = mailLink (viewSlot False) (HTML, (volumeId &lt;$&gt; notificationVolume, slot))</span></span>
<span class="lineno">  163 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">| otherwise = mailLink viewVolume (HTML, maybe noId volumeId notificationVolume)</span></span></span>
<span class="lineno">  164 </span>
<span class="lineno">  165 </span>mailNotifications :: Messages -&gt; [Notification] -&gt; TL.Text
<span class="lineno">  166 </span><span class="decl"><span class="istickedoff">mailNotifications msg ~l@(Notification{ notificationTarget = u }:_) =</span>
<span class="lineno">  167 </span><span class="spaces">  </span><span class="istickedoff">TL.fromChunks [&quot;Dear &quot;, partyName target, &quot;,\n&quot;]</span>
<span class="lineno">  168 </span><span class="spaces">  </span><span class="istickedoff">&lt;&gt; foldMap (\n -&gt; '\n' `TL.cons` mailNotification <span class="nottickedoff">msg</span> n `TL.snoc` <span class="nottickedoff">'\n'</span>) l</span>
<span class="lineno">  169 </span><span class="spaces">  </span><span class="istickedoff">&lt;&gt; <span class="nottickedoff">&quot;\nYou can change your notification settings or unsubscribe here: &quot;</span></span>
<span class="lineno">  170 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">&lt;&gt; partyEditLink mailLink target target [(&quot;page&quot;, &quot;notifications&quot;)] `TL.snoc` '\n'</span></span>
<span class="lineno">  171 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  172 </span><span class="spaces">  </span><span class="istickedoff">target = partyRow (accountParty u)</span></span>
<span class="lineno">  173 </span>
<span class="lineno">  174 </span>htmlNotification :: Messages -&gt; Notification -&gt; H.Html
<span class="lineno">  175 </span><span class="decl"><span class="nottickedoff">htmlNotification msg Notification{..} = case notificationNotice of</span>
<span class="lineno">  176 </span><span class="spaces">  </span><span class="nottickedoff">NoticeAccountChange -&gt;</span>
<span class="lineno">  177 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; changed &quot; &gt;&gt; party's &gt;&gt; &quot; &quot;</span>
<span class="lineno">  178 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; partyEdit (fromMaybe target notificationParty) [(&quot;page&quot;, &quot;account&quot;)] &quot;account information&quot; &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  179 </span><span class="spaces">  </span><span class="nottickedoff">NoticeAuthorizeRequest -&gt;</span>
<span class="lineno">  180 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; requested &quot;</span>
<span class="lineno">  181 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; partyEdit target [(&quot;page&quot;, &quot;apply&quot;), partyq] &quot;authorization&quot; &gt;&gt; &quot; from &quot; &gt;&gt; party &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  182 </span><span class="spaces">  </span><span class="nottickedoff">NoticeAuthorizeGranted -&gt;</span>
<span class="lineno">  183 </span><span class="spaces">    </span><span class="nottickedoff">&quot;Your &quot; &gt;&gt; partyEdit target [(&quot;page&quot;, &quot;apply&quot;), partyq] &quot;authorization&quot;</span>
<span class="lineno">  184 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; &quot; under &quot; &gt;&gt; fromMaybe &quot;yourself&quot; (person =&lt;&lt; notificationParty) &gt;&gt; &quot; has been &quot; &gt;&gt; granted &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  185 </span><span class="spaces">  </span><span class="nottickedoff">NoticeAuthorizeExpiring -&gt;</span>
<span class="lineno">  186 </span><span class="spaces">    </span><span class="nottickedoff">&quot;Your &quot; &gt;&gt; partyEdit target [(&quot;page&quot;, &quot;apply&quot;), partyq] &quot;authorization&quot; &gt;&gt; &quot; through &quot; &gt;&gt; party &gt;&gt; &quot; will expire soon.&quot;</span>
<span class="lineno">  187 </span><span class="spaces">  </span><span class="nottickedoff">NoticeAuthorizeExpired -&gt;</span>
<span class="lineno">  188 </span><span class="spaces">    </span><span class="nottickedoff">&quot;Your &quot; &gt;&gt; partyEdit target [(&quot;page&quot;, &quot;apply&quot;), partyq] &quot;authorization&quot; &gt;&gt; &quot; through &quot; &gt;&gt; party &gt;&gt; &quot; is expired.&quot;</span>
<span class="lineno">  189 </span><span class="spaces">  </span><span class="nottickedoff">NoticeAuthorizeChildRequest -&gt;</span>
<span class="lineno">  190 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; requested &quot;</span>
<span class="lineno">  191 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; partyEdit (fromMaybe target notificationParty) [(&quot;page&quot;, &quot;grant&quot;), personq $ Just notificationAgent] &quot;authorization&quot; &gt;&gt; &quot; from &quot; &gt;&gt; party &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  192 </span><span class="spaces">  </span><span class="nottickedoff">NoticeAuthorizeChildGranted -&gt;</span>
<span class="lineno">  193 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; &quot; &gt;&gt; granted &gt;&gt; &quot; &quot;</span>
<span class="lineno">  194 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; partyEdit target [(&quot;page&quot;, &quot;grant&quot;), partyq] &quot;authorization&quot; &gt;&gt; &quot; to &quot; &gt;&gt; party &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  195 </span><span class="spaces">  </span><span class="nottickedoff">NoticeAuthorizeChildExpiring -&gt;</span>
<span class="lineno">  196 </span><span class="spaces">    </span><span class="nottickedoff">party'S &gt;&gt; &quot; &quot; &gt;&gt; partyEdit target [(&quot;page&quot;, &quot;grant&quot;), partyq] &quot;authorization&quot; &gt;&gt; &quot; will expire soon.&quot;</span>
<span class="lineno">  197 </span><span class="spaces">  </span><span class="nottickedoff">NoticeAuthorizeChildExpired -&gt;</span>
<span class="lineno">  198 </span><span class="spaces">    </span><span class="nottickedoff">party'S &gt;&gt; &quot; &quot; &gt;&gt; partyEdit target [(&quot;page&quot;, &quot;grant&quot;), partyq] &quot;authorization&quot; &gt;&gt; &quot; is expired.&quot;</span>
<span class="lineno">  199 </span><span class="spaces">  </span><span class="nottickedoff">NoticeVolumeAssist -&gt;</span>
<span class="lineno">  200 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; requested &quot; &gt;&gt; volumeEdit [(&quot;page&quot;, &quot;assist&quot;)] &quot;assistance&quot; &gt;&gt; &quot; with &quot; &gt;&gt; volume &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  201 </span><span class="spaces">  </span><span class="nottickedoff">NoticeVolumeCreated -&gt;</span>
<span class="lineno">  202 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; created &quot; &gt;&gt; volume &gt;&gt; &quot; on &quot; &gt;&gt; party's &gt;&gt; &quot; behalf.&quot;</span>
<span class="lineno">  203 </span><span class="spaces">  </span><span class="nottickedoff">NoticeVolumeSharing -&gt;</span>
<span class="lineno">  204 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; changed &quot; &gt;&gt; volume &gt;&gt; &quot; to &quot;</span>
<span class="lineno">  205 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; H.text (volumeAccessPresetTitle (PermissionNONE &lt; perm) msg) &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  206 </span><span class="spaces">  </span><span class="nottickedoff">NoticeVolumeAccessOther -&gt;</span>
<span class="lineno">  207 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; set &quot; &gt;&gt; party's &gt;&gt; &quot; &quot;</span>
<span class="lineno">  208 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; volumeEdit [(&quot;page&quot;, &quot;access&quot;), partyq] &quot;access&quot; &gt;&gt; &quot; to &quot; &gt;&gt; H.text (volumeAccessTitle perm msg) &gt;&gt; &quot; on &quot; &gt;&gt; volume &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  209 </span><span class="spaces">  </span><span class="nottickedoff">NoticeVolumeAccess -&gt;</span>
<span class="lineno">  210 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; set &quot; &gt;&gt; party's &gt;&gt; &quot; &quot;</span>
<span class="lineno">  211 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; volumeEdit [(&quot;page&quot;, &quot;access&quot;)] &quot;access&quot; &gt;&gt; &quot; to &quot; &gt;&gt; H.text (volumeAccessTitle perm msg) &gt;&gt; &quot; on &quot; &gt;&gt; volume &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  212 </span><span class="spaces">  </span><span class="nottickedoff">NoticeReleaseSlot -&gt;</span>
<span class="lineno">  213 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; set a &quot; &gt;&gt; link (viewSlot False) (HTML, (volumeId &lt;$&gt; notificationVolume, slot)) [] &quot;folder&quot;</span>
<span class="lineno">  214 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; &quot; in &quot; &gt;&gt; volume &gt;&gt; &quot; to &quot; &gt;&gt; H.text (releaseTitle notificationRelease msg) &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  215 </span><span class="spaces">  </span><span class="nottickedoff">NoticeReleaseAsset -&gt;</span>
<span class="lineno">  216 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; set a &quot; &gt;&gt; link (viewSlot False) (HTML, (volumeId &lt;$&gt; notificationVolume, slot)) [(&quot;asset&quot;, foldMap (BSC.pack . show) notificationAssetId)] &quot;file&quot;</span>
<span class="lineno">  217 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; &quot; in &quot; &gt;&gt; volume &gt;&gt; &quot; to &quot; &gt;&gt; H.text (releaseTitle notificationRelease msg) &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  218 </span><span class="spaces">  </span><span class="nottickedoff">NoticeReleaseExcerpt -&gt;</span>
<span class="lineno">  219 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; set a &quot; &gt;&gt; assetSegment &quot;highlight&quot;</span>
<span class="lineno">  220 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; &quot; in &quot; &gt;&gt; volume &gt;&gt; &quot; to &quot; &gt;&gt; H.text (releaseTitle notificationRelease msg) &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  221 </span><span class="spaces">  </span><span class="nottickedoff">NoticeExcerptVolume -&gt;</span>
<span class="lineno">  222 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; created a &quot; &gt;&gt; assetSegment &quot;highlight&quot;</span>
<span class="lineno">  223 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; &quot; in &quot; &gt;&gt; volume &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  224 </span><span class="spaces">  </span><span class="nottickedoff">NoticeCommentVolume -&gt;</span>
<span class="lineno">  225 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; &quot; &gt;&gt; (slotVolume [] (&quot;#comment-&quot; &lt;&gt; foldMap (H.toValue . unId) notificationCommentId)) &quot;commented&quot;</span>
<span class="lineno">  226 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; &quot; on &quot; &gt;&gt; volume &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  227 </span><span class="spaces">  </span><span class="nottickedoff">NoticeCommentReply -&gt;</span>
<span class="lineno">  228 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; &quot; &gt;&gt; (slotVolume [] (&quot;#comment-&quot; &lt;&gt; foldMap (H.toValue . unId) notificationCommentId)) &quot;replied&quot;</span>
<span class="lineno">  229 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; &quot; to your comment on &quot; &gt;&gt; volume &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  230 </span><span class="spaces">  </span><span class="nottickedoff">NoticeTagVolume -&gt;</span>
<span class="lineno">  231 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; &quot; &gt;&gt; (slotVolume [(&quot;tag&quot;, foldMap (tagNameBS . tagName) notificationTag)] &quot;#panel-tags&quot;) &quot;tagged&quot;</span>
<span class="lineno">  232 </span><span class="spaces">    </span><span class="nottickedoff">&gt;&gt; &quot; &quot; &gt;&gt; volume &gt;&gt; &quot; with &quot; &gt;&gt; H.em (mapM_ (byteStringHtml . tagNameBS . tagName) notificationTag) &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  233 </span><span class="spaces">  </span><span class="nottickedoff">NoticeSharedVolume -&gt;</span>
<span class="lineno">  234 </span><span class="spaces">    </span><span class="nottickedoff">agent &gt;&gt; &quot; shared &quot; &gt;&gt; volume &gt;&gt; &quot;.&quot;</span>
<span class="lineno">  235 </span><span class="spaces">  </span><span class="nottickedoff">NoticeNewsletter -&gt;</span>
<span class="lineno">  236 </span><span class="spaces">    </span><span class="nottickedoff">&quot;A new &quot; &gt;&gt; (H.a H.! HA.href &quot;//databrary.org/news.html&quot;) &quot;Databrary newsletter&quot; &gt;&gt; &quot; has been posted.&quot;</span>
<span class="lineno">  237 </span><span class="spaces">  </span><span class="nottickedoff">where</span>
<span class="lineno">  238 </span><span class="spaces">  </span><span class="nottickedoff">target = partyRow (accountParty notificationTarget)</span>
<span class="lineno">  239 </span><span class="spaces">  </span><span class="nottickedoff">person p = (on (/=) partyId p target) `thenUse` (htmlPartyViewLink p ([] :: Query))</span>
<span class="lineno">  240 </span><span class="spaces">  </span><span class="nottickedoff">agent = fromMaybe &quot;You&quot; $ person notificationAgent</span>
<span class="lineno">  241 </span><span class="spaces">  </span><span class="nottickedoff">partyp = fmap ((any (on (/=) partyId notificationAgent) notificationParty) `thenUse`) $ person =&lt;&lt; notificationParty</span>
<span class="lineno">  242 </span><span class="spaces">  </span><span class="nottickedoff">party = maybe &quot;you&quot; (fromMaybe &quot;themselves&quot;) partyp</span>
<span class="lineno">  243 </span><span class="spaces">  </span><span class="nottickedoff">party'sOr your their = maybe your (maybe their (&gt;&gt; &quot;'s&quot;)) partyp</span>
<span class="lineno">  244 </span><span class="spaces">  </span><span class="nottickedoff">party's = party'sOr &quot;your&quot; &quot;their own&quot;</span>
<span class="lineno">  245 </span><span class="spaces">  </span><span class="nottickedoff">party'S = party'sOr &quot;Your&quot; &quot;Their own&quot;</span>
<span class="lineno">  246 </span><span class="spaces">  </span><span class="nottickedoff">personq p = (&quot;party&quot;, maybe &quot;&quot; (BSC.pack . show . partyId) p)</span>
<span class="lineno">  247 </span><span class="spaces">  </span><span class="nottickedoff">partyq = personq notificationParty</span>
<span class="lineno">  248 </span><span class="spaces">  </span><span class="nottickedoff">link u a q h = H.a H.! actionLink u a (map (second Just) q :: Query) $ h</span>
<span class="lineno">  249 </span><span class="spaces">  </span><span class="nottickedoff">partyEdit = partyEditLink link target</span>
<span class="lineno">  250 </span><span class="spaces">  </span><span class="nottickedoff">granted = maybe &quot;revoked&quot; (const &quot;granted&quot;) notificationPermission</span>
<span class="lineno">  251 </span><span class="spaces">  </span><span class="nottickedoff">volume = maybe &quot;&lt;VOLUME&gt;&quot; (\v -&gt; htmlVolumeViewLink v ([] :: Query)) notificationVolume</span>
<span class="lineno">  252 </span><span class="spaces">  </span><span class="nottickedoff">volumeEdit = link viewVolumeEdit (maybe noId volumeId notificationVolume)</span>
<span class="lineno">  253 </span><span class="spaces">  </span><span class="nottickedoff">perm = fromMaybe PermissionNONE notificationPermission</span>
<span class="lineno">  254 </span><span class="spaces">  </span><span class="nottickedoff">slot = Id $ SlotId (fromMaybe noId notificationContainerId) (fromMaybe fullSegment notificationSegment)</span>
<span class="lineno">  255 </span><span class="spaces">  </span><span class="nottickedoff">assetSegment = link (viewAssetSegment False)(HTML, volumeId &lt;$&gt; notificationVolume, slot, fromMaybe noId notificationAssetId) []</span>
<span class="lineno">  256 </span><span class="spaces">  </span><span class="nottickedoff">slotVolume q t = H.a H.! HA.href (if isJust notificationContainerId</span>
<span class="lineno">  257 </span><span class="spaces">    </span><span class="nottickedoff">then actionValue (viewSlot False) (HTML, (volumeId &lt;$&gt; notificationVolume, slot)) (q :: [(BSC.ByteString, BSC.ByteString)]) &lt;&gt; t</span>
<span class="lineno">  258 </span><span class="spaces">    </span><span class="nottickedoff">else actionValue viewVolume (HTML, maybe noId volumeId notificationVolume) q &lt;&gt; t)</span></span>
<span class="lineno">  259 </span>
<span class="lineno">  260 </span>noId :: Num (IdType a) =&gt; Id a
<span class="lineno">  261 </span><span class="decl"><span class="nottickedoff">noId = (Id $ -1)</span></span>

</pre>
</body>
</html>
