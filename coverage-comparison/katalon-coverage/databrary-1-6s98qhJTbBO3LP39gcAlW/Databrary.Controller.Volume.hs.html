<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE OverloadedStrings, TupleSections, ScopedTypeVariables #-}
<span class="lineno">    2 </span>module Databrary.Controller.Volume
<span class="lineno">    3 </span>  ( getVolume
<span class="lineno">    4 </span>  , viewVolume
<span class="lineno">    5 </span>  , viewVolumeEdit
<span class="lineno">    6 </span>  , viewVolumeCreateHandler
<span class="lineno">    7 </span>  , postVolume
<span class="lineno">    8 </span>  , createVolume
<span class="lineno">    9 </span>  -- , viewVolumeLinks
<span class="lineno">   10 </span>  , postVolumeLinks
<span class="lineno">   11 </span>  , postVolumeAssist
<span class="lineno">   12 </span>  , queryVolumes
<span class="lineno">   13 </span>  , thumbVolume
<span class="lineno">   14 </span>  , volumeDownloadName
<span class="lineno">   15 </span>  -- , volumeJSONQuery
<span class="lineno">   16 </span>  , volumeIsPublicRestricted
<span class="lineno">   17 </span>  ) where
<span class="lineno">   18 </span>
<span class="lineno">   19 </span>import Control.Applicative ((&lt;|&gt;), optional)
<span class="lineno">   20 </span>import Control.Arrow ((&amp;&amp;&amp;), (***))
<span class="lineno">   21 </span>import Control.Monad (mfilter, guard, void, when, forM_)
<span class="lineno">   22 </span>-- import Control.Monad.IO.Class (liftIO)
<span class="lineno">   23 </span>import Control.Monad.Trans.Class (lift)
<span class="lineno">   24 </span>import Control.Monad.Trans.State.Lazy (StateT(..), evalStateT, get, put)
<span class="lineno">   25 </span>import qualified Data.ByteString as BS
<span class="lineno">   26 </span>import qualified Data.ByteString.Char8 as BSC
<span class="lineno">   27 </span>import qualified Data.HashMap.Lazy as HML
<span class="lineno">   28 </span>import qualified Data.HashMap.Strict as HM
<span class="lineno">   29 </span>import Data.Function (on)
<span class="lineno">   30 </span>import Data.Maybe (fromMaybe, isNothing)
<span class="lineno">   31 </span>import Data.Monoid ((&lt;&gt;))
<span class="lineno">   32 </span>import qualified Data.Text as T
<span class="lineno">   33 </span>import qualified Data.Text.Lazy as TL
<span class="lineno">   34 </span>import Network.HTTP.Types (noContent204, unsupportedMediaType415)
<span class="lineno">   35 </span>import qualified Network.Wai as Wai
<span class="lineno">   36 </span>
<span class="lineno">   37 </span>import Databrary.Ops
<span class="lineno">   38 </span>import Databrary.Has
<span class="lineno">   39 </span>import qualified Databrary.JSON as JSON
<span class="lineno">   40 </span>import Databrary.Model.Asset (Asset)
<span class="lineno">   41 </span>import Databrary.Model.Enum
<span class="lineno">   42 </span>import Databrary.Model.Id
<span class="lineno">   43 </span>import Databrary.Model.Permission
<span class="lineno">   44 </span>import Databrary.Model.Authorize
<span class="lineno">   45 </span>import Databrary.Model.Volume
<span class="lineno">   46 </span>import Databrary.Model.VolumeAccess
<span class="lineno">   47 </span>import Databrary.Model.Party
<span class="lineno">   48 </span>import Databrary.Model.Citation
<span class="lineno">   49 </span>import Databrary.Model.Citation.CrossRef
<span class="lineno">   50 </span>import Databrary.Model.Funding
<span class="lineno">   51 </span>import Databrary.Model.Container
<span class="lineno">   52 </span>import Databrary.Model.Record
<span class="lineno">   53 </span>import Databrary.Model.VolumeMetric
<span class="lineno">   54 </span>import Databrary.Model.RecordSlot
<span class="lineno">   55 </span>import Databrary.Model.Segment (Segment)
<span class="lineno">   56 </span>import Databrary.Model.Slot
<span class="lineno">   57 </span>import Databrary.Model.AssetSlot
<span class="lineno">   58 </span>import Databrary.Model.Excerpt
<span class="lineno">   59 </span>import Databrary.Model.Tag
<span class="lineno">   60 </span>import Databrary.Model.Comment
<span class="lineno">   61 </span>import Databrary.Model.VolumeState
<span class="lineno">   62 </span>import Databrary.Model.Notification.Types
<span class="lineno">   63 </span>import Databrary.Store.Filename
<span class="lineno">   64 </span>import Databrary.Static.Service
<span class="lineno">   65 </span>import Databrary.Service.Mail
<span class="lineno">   66 </span>import Databrary.HTTP.Parse
<span class="lineno">   67 </span>import Databrary.HTTP.Form.Deform
<span class="lineno">   68 </span>import Databrary.HTTP.Path.Parser
<span class="lineno">   69 </span>import Databrary.Action.Route
<span class="lineno">   70 </span>import Databrary.Action
<span class="lineno">   71 </span>import Databrary.Controller.Paths
<span class="lineno">   72 </span>import Databrary.Controller.Permission
<span class="lineno">   73 </span>import Databrary.Controller.Form
<span class="lineno">   74 </span>import Databrary.Controller.Angular
<span class="lineno">   75 </span>import Databrary.Controller.Web
<span class="lineno">   76 </span>import {-# SOURCE #-} Databrary.Controller.AssetSegment
<span class="lineno">   77 </span>import Databrary.Controller.Notification
<span class="lineno">   78 </span>import Databrary.View.Form (FormHtml)
<span class="lineno">   79 </span>
<span class="lineno">   80 </span>getVolume :: Permission -&gt; Id Volume -&gt; Handler Volume
<span class="lineno">   81 </span><span class="decl"><span class="istickedoff">getVolume p i = do</span>
<span class="lineno">   82 </span><span class="spaces">  </span><span class="istickedoff">mVol &lt;- lookupVolume i</span>
<span class="lineno">   83 </span><span class="spaces">  </span><span class="istickedoff">vol &lt;- maybeAction mVol</span>
<span class="lineno">   84 </span><span class="spaces">  </span><span class="istickedoff">checkPermission p vol</span></span>
<span class="lineno">   85 </span>
<span class="lineno">   86 </span>data VolumeCache = VolumeCache
<span class="lineno">   87 </span>  { <span class="istickedoff"><span class="decl"><span class="istickedoff">volumeCacheAccess</span></span></span> :: Maybe [VolumeAccess]
<span class="lineno">   88 </span>  , <span class="istickedoff"><span class="decl"><span class="istickedoff">volumeCacheTopContainer</span></span></span> :: Maybe Container
<span class="lineno">   89 </span>  , <span class="istickedoff"><span class="decl"><span class="istickedoff">volumeCacheRecords</span></span></span> :: Maybe (HML.HashMap (Id Record) Record)
<span class="lineno">   90 </span>  }
<span class="lineno">   91 </span>
<span class="lineno">   92 </span>-- type VolumeCacheHandler a = StateT VolumeCache Handler a
<span class="lineno">   93 </span>
<span class="lineno">   94 </span>instance Monoid VolumeCache where
<span class="lineno">   95 </span>  <span class="decl"><span class="istickedoff">mempty = VolumeCache Nothing Nothing Nothing</span></span>
<span class="lineno">   96 </span>  <span class="decl"><span class="nottickedoff">mappend (VolumeCache a1 t1 r1) (VolumeCache a2 t2 r2) = VolumeCache (a1 &lt;|&gt; a2) (t1 &lt;|&gt; t2) (r1 &lt;&gt; r2)</span></span>
<span class="lineno">   97 </span>
<span class="lineno">   98 </span>runVolumeCache :: StateT VolumeCache Handler a -&gt; Handler a
<span class="lineno">   99 </span><span class="decl"><span class="istickedoff">runVolumeCache f = evalStateT f mempty</span></span>
<span class="lineno">  100 </span>
<span class="lineno">  101 </span>cacheVolumeAccess :: Volume -&gt; Permission -&gt; StateT VolumeCache Handler [VolumeAccess]
<span class="lineno">  102 </span><span class="decl"><span class="istickedoff">cacheVolumeAccess vol perm = do</span>
<span class="lineno">  103 </span><span class="spaces">  </span><span class="istickedoff">vc &lt;- get</span>
<span class="lineno">  104 </span><span class="spaces">  </span><span class="istickedoff">takeWhile ((perm &lt;=) . volumeAccessIndividual) &lt;$&gt;</span>
<span class="lineno">  105 </span><span class="spaces">    </span><span class="istickedoff">fromMaybeM (do</span>
<span class="lineno">  106 </span><span class="spaces">      </span><span class="istickedoff">a &lt;- lookupVolumeAccess vol PermissionNONE</span>
<span class="lineno">  107 </span><span class="spaces">      </span><span class="istickedoff">put vc{ volumeCacheAccess = <span class="nottickedoff">Just a</span> }</span>
<span class="lineno">  108 </span><span class="spaces">      </span><span class="istickedoff">return a)</span>
<span class="lineno">  109 </span><span class="spaces">      </span><span class="istickedoff">(volumeCacheAccess vc)</span></span>
<span class="lineno">  110 </span>
<span class="lineno">  111 </span>cacheVolumeRecords :: Volume -&gt; StateT VolumeCache Handler ([Record], HML.HashMap (Id Record) Record)
<span class="lineno">  112 </span><span class="decl"><span class="istickedoff">cacheVolumeRecords vol = do</span>
<span class="lineno">  113 </span><span class="spaces">  </span><span class="istickedoff">vc &lt;- get</span>
<span class="lineno">  114 </span><span class="spaces">  </span><span class="istickedoff">maybe (do</span>
<span class="lineno">  115 </span><span class="spaces">    </span><span class="istickedoff">l &lt;- lookupVolumeRecords vol</span>
<span class="lineno">  116 </span><span class="spaces">    </span><span class="istickedoff">let m = HML.fromList [ (recordId $ recordRow r, r) | r &lt;- l ]</span>
<span class="lineno">  117 </span><span class="spaces">    </span><span class="istickedoff">put vc{ volumeCacheRecords = Just m }</span>
<span class="lineno">  118 </span><span class="spaces">    </span><span class="istickedoff">return (l, <span class="nottickedoff">m</span>))</span>
<span class="lineno">  119 </span><span class="spaces">    </span><span class="istickedoff">(return . (<span class="nottickedoff">HML.elems</span> &amp;&amp;&amp; id))</span>
<span class="lineno">  120 </span><span class="spaces">    </span><span class="istickedoff">(volumeCacheRecords vc)</span></span>
<span class="lineno">  121 </span>
<span class="lineno">  122 </span>cacheVolumeTopContainer :: Volume -&gt; StateT VolumeCache Handler Container
<span class="lineno">  123 </span><span class="decl"><span class="istickedoff">cacheVolumeTopContainer vol = do</span>
<span class="lineno">  124 </span><span class="spaces">  </span><span class="istickedoff">vc &lt;- get</span>
<span class="lineno">  125 </span><span class="spaces">  </span><span class="istickedoff">fromMaybeM (do</span>
<span class="lineno">  126 </span><span class="spaces">    </span><span class="istickedoff">t &lt;- lookupVolumeTopContainer vol</span>
<span class="lineno">  127 </span><span class="spaces">    </span><span class="istickedoff">put vc{ volumeCacheTopContainer = Just t }</span>
<span class="lineno">  128 </span><span class="spaces">    </span><span class="istickedoff">return t)</span>
<span class="lineno">  129 </span><span class="spaces">    </span><span class="istickedoff">(volumeCacheTopContainer vc)</span></span>
<span class="lineno">  130 </span>
<span class="lineno">  131 </span>leftJoin :: (a -&gt; b -&gt; Bool) -&gt; [a] -&gt; [b] -&gt; [(a, [b])]
<span class="lineno">  132 </span><span class="decl"><span class="istickedoff">leftJoin _ [] [] = []</span>
<span class="lineno">  133 </span><span class="spaces"></span><span class="istickedoff">leftJoin _ [] _ = <span class="nottickedoff">error &quot;leftJoin: leftovers&quot;</span></span>
<span class="lineno">  134 </span><span class="spaces"></span><span class="istickedoff">leftJoin p (a:al) b = uncurry (:) $ (,) a *** leftJoin p al $ span (p a) b</span></span>
<span class="lineno">  135 </span>
<span class="lineno">  136 </span>volumeIsPublicRestricted :: Volume -&gt; Bool
<span class="lineno">  137 </span><span class="decl"><span class="istickedoff">volumeIsPublicRestricted v =</span>
<span class="lineno">  138 </span><span class="spaces">  </span><span class="istickedoff">case volumeRolePolicy v of</span>
<span class="lineno">  139 </span><span class="spaces">    </span><span class="istickedoff">RolePublicViewer PublicRestrictedPolicy -&gt; <span class="nottickedoff">True</span></span>
<span class="lineno">  140 </span><span class="spaces">    </span><span class="istickedoff">RoleSharedViewer SharedRestrictedPolicy -&gt; <span class="nottickedoff">True</span></span>
<span class="lineno">  141 </span><span class="spaces">    </span><span class="istickedoff">_ -&gt; False</span></span>
<span class="lineno">  142 </span>
<span class="lineno">  143 </span>volumeJSONField :: Volume -&gt; BS.ByteString -&gt; Maybe BS.ByteString -&gt; StateT VolumeCache Handler (Maybe JSON.Encoding)
<span class="lineno">  144 </span><span class="decl"><span class="istickedoff">volumeJSONField vol &quot;access&quot; ma = do</span>
<span class="lineno">  145 </span><span class="spaces">  </span><span class="istickedoff">Just . JSON.mapObjects volumeAccessPartyJSON</span>
<span class="lineno">  146 </span><span class="spaces">    </span><span class="istickedoff">&lt;$&gt; cacheVolumeAccess vol (fromMaybe PermissionNONE $ <span class="nottickedoff">readDBEnum . BSC.unpack</span> =&lt;&lt; ma)</span>
<span class="lineno">  147 </span><span class="spaces"></span><span class="istickedoff">{-</span>
<span class="lineno">  148 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField vol &quot;publicaccess&quot; ma = do</span>
<span class="lineno">  149 </span><span class="spaces">  </span><span class="istickedoff">Just . JSON.toEncoding . show . volumePublicAccessSummary</span>
<span class="lineno">  150 </span><span class="spaces">    </span><span class="istickedoff">&lt;$&gt; cacheVolumeAccess vol (fromMaybe PermissionNONE $ readDBEnum . BSC.unpack =&lt;&lt; ma)</span>
<span class="lineno">  151 </span><span class="spaces"></span><span class="istickedoff">-}</span>
<span class="lineno">  152 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField vol &quot;citation&quot; _ =</span>
<span class="lineno">  153 </span><span class="spaces">  </span><span class="istickedoff">Just . JSON.toEncoding &lt;$&gt; lookupVolumeCitation vol</span>
<span class="lineno">  154 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField vol &quot;links&quot; _ =</span>
<span class="lineno">  155 </span><span class="spaces">  </span><span class="istickedoff">Just . JSON.toEncoding &lt;$&gt; lookupVolumeLinks vol</span>
<span class="lineno">  156 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField vol &quot;funding&quot; _ =</span>
<span class="lineno">  157 </span><span class="spaces">  </span><span class="istickedoff">Just . JSON.mapObjects <span class="nottickedoff">fundingJSON</span> &lt;$&gt; lookupVolumeFunding vol</span>
<span class="lineno">  158 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField vol &quot;containers&quot; mContainersVal = do</span>
<span class="lineno">  159 </span><span class="spaces">  </span><span class="istickedoff">(cl :: [((Container, [(Segment, Id Record)]))]) &lt;- if <span class="tickonlytrue">records</span></span>
<span class="lineno">  160 </span><span class="spaces">    </span><span class="istickedoff">then lookupVolumeContainersRecordIds vol</span>
<span class="lineno">  161 </span><span class="spaces">    </span><span class="istickedoff">else <span class="nottickedoff">nope &lt;$&gt; lookupVolumeContainers vol</span></span>
<span class="lineno">  162 </span><span class="spaces">  </span><span class="istickedoff">(cl' :: [((Container, [(Segment, Id Record)]), [(Asset, SlotId)])]) &lt;- if <span class="tickonlytrue">assets</span></span>
<span class="lineno">  163 </span><span class="spaces">    </span><span class="istickedoff">then leftJoin (\(c, _) (_, SlotId a _) -&gt; containerId (containerRow c) == a) cl &lt;$&gt; lookupVolumeAssetSlotIds vol</span>
<span class="lineno">  164 </span><span class="spaces">    </span><span class="istickedoff">else <span class="nottickedoff">return $ nope cl</span></span>
<span class="lineno">  165 </span><span class="spaces">  </span><span class="istickedoff">rm &lt;- if <span class="tickonlytrue">records</span> then snd &lt;$&gt; cacheVolumeRecords <span class="nottickedoff">vol</span> else <span class="nottickedoff">return HM.empty</span></span>
<span class="lineno">  166 </span><span class="spaces">  </span><span class="istickedoff">let publicRestricted = volumeIsPublicRestricted vol</span>
<span class="lineno">  167 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">br = blankRecord undefined vol</span></span>
<span class="lineno">  168 </span><span class="spaces">      </span><span class="istickedoff">rjs c (s, r)          = JSON.recordObject $ (recordSlotJSON <span class="nottickedoff">publicRestricted</span>) $ RecordSlot (HML.lookupDefault <span class="nottickedoff">br{ recordRow = (recordRow br){ recordId = r } }</span> r rm) (Slot c s)</span>
<span class="lineno">  169 </span><span class="spaces">      </span><span class="istickedoff">ajs c (a, SlotId _ s) = JSON.recordObject $ (assetSlotJSON publicRestricted) $ AssetSlot a (Just (Slot c s))</span>
<span class="lineno">  170 </span><span class="spaces">  </span><span class="istickedoff">return $ Just $ JSON.mapRecords (\((c, rl), al) -&gt;</span>
<span class="lineno">  171 </span><span class="spaces">      </span><span class="istickedoff">containerJSON publicRestricted c</span>
<span class="lineno">  172 </span><span class="spaces">      </span><span class="istickedoff">`JSON.foldObjectIntoRec`</span>
<span class="lineno">  173 </span><span class="spaces">            </span><span class="istickedoff">(   (if <span class="tickonlytrue">records</span> then JSON.nestObject &quot;records&quot; (\u -&gt; map (u . rjs c) rl) else <span class="nottickedoff">mempty</span>)</span>
<span class="lineno">  174 </span><span class="spaces">             </span><span class="istickedoff">&lt;&gt; (if <span class="tickonlytrue">assets</span>  then JSON.nestObject &quot;assets&quot;  (\u -&gt; map (u . ajs c) al) else <span class="nottickedoff">mempty</span>)))</span>
<span class="lineno">  175 </span><span class="spaces">    </span><span class="istickedoff">cl'</span>
<span class="lineno">  176 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  177 </span><span class="spaces">  </span><span class="istickedoff">full = mContainersVal == Just &quot;all&quot;</span>
<span class="lineno">  178 </span><span class="spaces">  </span><span class="istickedoff">assets = full || <span class="nottickedoff">mContainersVal == Just &quot;assets&quot;</span></span>
<span class="lineno">  179 </span><span class="spaces">  </span><span class="istickedoff">records = full || <span class="nottickedoff">mContainersVal == Just &quot;records&quot;</span></span>
<span class="lineno">  180 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">nope = map (, [])</span></span>
<span class="lineno">  181 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField vol &quot;top&quot; _ = do</span>
<span class="lineno">  182 </span><span class="spaces">  </span><span class="istickedoff">topCntr &lt;- cacheVolumeTopContainer vol</span>
<span class="lineno">  183 </span><span class="spaces">  </span><span class="istickedoff">let publicRestricted = volumeIsPublicRestricted vol</span>
<span class="lineno">  184 </span><span class="spaces">  </span><span class="istickedoff">(return . Just . JSON.recordEncoding . containerJSON publicRestricted) topCntr</span>
<span class="lineno">  185 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField vol &quot;records&quot; _ = do</span>
<span class="lineno">  186 </span><span class="spaces">  </span><span class="istickedoff">(l, _) &lt;- cacheVolumeRecords vol</span>
<span class="lineno">  187 </span><span class="spaces">  </span><span class="istickedoff">let publicRestricted = volumeIsPublicRestricted vol</span>
<span class="lineno">  188 </span><span class="spaces">  </span><span class="istickedoff">return $ Just $ JSON.mapRecords (recordJSON publicRestricted) l</span>
<span class="lineno">  189 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField vol &quot;metrics&quot; _ =</span>
<span class="lineno">  190 </span><span class="spaces">  </span><span class="istickedoff">let metricsCaching = lookupVolumeMetrics vol</span>
<span class="lineno">  191 </span><span class="spaces">  </span><span class="istickedoff">in (Just . JSON.toEncoding) &lt;$&gt; metricsCaching</span>
<span class="lineno">  192 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField vol &quot;excerpts&quot; _ = do</span>
<span class="lineno">  193 </span><span class="spaces">  </span><span class="istickedoff">Just . JSON.mapObjects (\e -&gt; excerptJSON e</span>
<span class="lineno">  194 </span><span class="spaces">    </span><span class="istickedoff">&lt;&gt; &quot;asset&quot; JSON..=: (assetSlotJSON False (view e) -- should publicRestricted be set based on volume?</span>
<span class="lineno">  195 </span><span class="spaces">      </span><span class="istickedoff">`JSON.foldObjectIntoRec` (&quot;container&quot; JSON..= (view e :: Id Container))))</span>
<span class="lineno">  196 </span><span class="spaces">    </span><span class="istickedoff">&lt;$&gt; lookupVolumeExcerpts vol</span>
<span class="lineno">  197 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField vol &quot;tags&quot; n = do</span>
<span class="lineno">  198 </span><span class="spaces">  </span><span class="istickedoff">t &lt;- cacheVolumeTopContainer <span class="nottickedoff">vol</span></span>
<span class="lineno">  199 </span><span class="spaces">  </span><span class="istickedoff">tc &lt;- lookupSlotTagCoverage (containerSlot t) (maybe 64 <span class="nottickedoff">fst</span> $ BSC.readInt =&lt;&lt; n)</span>
<span class="lineno">  200 </span><span class="spaces">  </span><span class="istickedoff">return $ Just $ JSON.mapRecords tagCoverageJSON tc</span>
<span class="lineno">  201 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField vol &quot;comments&quot; n = do</span>
<span class="lineno">  202 </span><span class="spaces">  </span><span class="istickedoff">t &lt;- cacheVolumeTopContainer <span class="nottickedoff">vol</span></span>
<span class="lineno">  203 </span><span class="spaces">  </span><span class="istickedoff">tc &lt;- lookupSlotComments (containerSlot t) (maybe 64 <span class="nottickedoff">fst</span> $ <span class="nottickedoff">BSC.readInt</span> =&lt;&lt; n)</span>
<span class="lineno">  204 </span><span class="spaces">  </span><span class="istickedoff">return $ Just $ JSON.mapRecords <span class="nottickedoff">commentJSON</span> tc</span>
<span class="lineno">  205 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField vol &quot;state&quot; _ =</span>
<span class="lineno">  206 </span><span class="spaces">  </span><span class="istickedoff">Just . JSON.toEncoding . JSON.object . map <span class="nottickedoff">(volumeStateKey &amp;&amp;&amp; volumeStateValue)</span> &lt;$&gt; lookupVolumeState vol</span>
<span class="lineno">  207 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField o &quot;filename&quot; _ =</span>
<span class="lineno">  208 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">return $ Just $ JSON.toEncoding $ makeFilename $ volumeDownloadName o</span></span>
<span class="lineno">  209 </span><span class="spaces"></span><span class="istickedoff">volumeJSONField _ _ _ = <span class="nottickedoff">return Nothing</span></span></span>
<span class="lineno">  210 </span>
<span class="lineno">  211 </span>volumeJSONQuery :: Volume -&gt; Maybe [VolumeAccess] -&gt; JSON.Query -&gt; Handler (JSON.Record (Id Volume) JSON.Series)
<span class="lineno">  212 </span><span class="decl"><span class="istickedoff">volumeJSONQuery vol mAccesses q =</span>
<span class="lineno">  213 </span><span class="spaces">  </span><span class="istickedoff">let seriesCaching :: StateT VolumeCache Handler JSON.Series</span>
<span class="lineno">  214 </span><span class="spaces">      </span><span class="istickedoff">seriesCaching = JSON.jsonQuery (volumeJSONField vol) q</span>
<span class="lineno">  215 </span><span class="spaces">      </span><span class="istickedoff">expandedVolJSONcaching :: StateT VolumeCache Handler (JSON.Record (Id Volume) JSON.Series)</span>
<span class="lineno">  216 </span><span class="spaces">      </span><span class="istickedoff">expandedVolJSONcaching = (\series -&gt; volumeJSON vol mAccesses `JSON.foldObjectIntoRec` series) &lt;$&gt; seriesCaching</span>
<span class="lineno">  217 </span><span class="spaces">  </span><span class="istickedoff">in</span>
<span class="lineno">  218 </span><span class="spaces">    </span><span class="istickedoff">runVolumeCache $ expandedVolJSONcaching</span></span>
<span class="lineno">  219 </span>
<span class="lineno">  220 </span>volumeDownloadName :: Volume -&gt; [T.Text]
<span class="lineno">  221 </span><span class="decl"><span class="istickedoff">volumeDownloadName v =</span>
<span class="lineno">  222 </span><span class="spaces">  </span><span class="istickedoff">(T.pack $ &quot;databrary&quot; ++ show (volumeId $ volumeRow v))</span>
<span class="lineno">  223 </span><span class="spaces">    </span><span class="istickedoff">: map (T.takeWhile (',' /=) . snd) (volumeOwners v)</span>
<span class="lineno">  224 </span><span class="spaces">    </span><span class="istickedoff">++ [fromMaybe (volumeName $ volumeRow v) (getVolumeAlias v)]</span></span>
<span class="lineno">  225 </span>
<span class="lineno">  226 </span>viewVolume :: ActionRoute (API, Id Volume)
<span class="lineno">  227 </span><span class="decl"><span class="istickedoff">viewVolume = action GET (pathAPI &lt;/&gt; pathId) $ \(api, vi) -&gt; withAuth $ do</span>
<span class="lineno">  228 </span><span class="spaces">  </span><span class="istickedoff">when (api == HTML) angular</span>
<span class="lineno">  229 </span><span class="spaces">  </span><span class="istickedoff">v &lt;- getVolume PermissionPUBLIC vi</span>
<span class="lineno">  230 </span><span class="spaces">  </span><span class="istickedoff">accesses &lt;- lookupVolumeAccess v PermissionNONE</span>
<span class="lineno">  231 </span><span class="spaces">  </span><span class="istickedoff">-- (liftIO . print) (&quot;num accesses&quot;, length accesses)</span>
<span class="lineno">  232 </span><span class="spaces">  </span><span class="istickedoff">-- case api of</span>
<span class="lineno">  233 </span><span class="spaces">  </span><span class="istickedoff">(let idSeriesRecAct :: Handler (JSON.Record (Id Volume) JSON.Series)</span>
<span class="lineno">  234 </span><span class="spaces">       </span><span class="istickedoff">idSeriesRecAct = volumeJSONQuery v (Just accesses) =&lt;&lt; peeks Wai.queryString</span>
<span class="lineno">  235 </span><span class="spaces">   </span><span class="istickedoff">in okResponse [] . JSON.recordEncoding &lt;$&gt; idSeriesRecAct)</span></span>
<span class="lineno">  236 </span>  {-
<span class="lineno">  237 </span>    HTML -&gt; do
<span class="lineno">  238 </span>      top &lt;- lookupVolumeTopContainer v
<span class="lineno">  239 </span>      t &lt;- lookupSlotKeywords $ containerSlot top
<span class="lineno">  240 </span>      peeks $ okResponse [] . htmlVolumeView v t
<span class="lineno">  241 </span>  -}
<span class="lineno">  242 </span>
<span class="lineno">  243 </span>volumeForm :: Volume -&gt; DeformHandler f Volume
<span class="lineno">  244 </span><span class="decl"><span class="istickedoff">volumeForm v = do</span>
<span class="lineno">  245 </span><span class="spaces">  </span><span class="istickedoff">name &lt;- &quot;name&quot; .:&gt; deform</span>
<span class="lineno">  246 </span><span class="spaces">  </span><span class="istickedoff">alias &lt;- &quot;alias&quot; .:&gt; deformNonEmpty <span class="nottickedoff">deform</span></span>
<span class="lineno">  247 </span><span class="spaces">  </span><span class="istickedoff">body &lt;- &quot;body&quot; .:&gt; deformNonEmpty deform</span>
<span class="lineno">  248 </span><span class="spaces">  </span><span class="istickedoff">return v</span>
<span class="lineno">  249 </span><span class="spaces">    </span><span class="istickedoff">{ volumeRow = (volumeRow v)</span>
<span class="lineno">  250 </span><span class="spaces">      </span><span class="istickedoff">{ volumeName = name</span>
<span class="lineno">  251 </span><span class="spaces">      </span><span class="istickedoff">, volumeAlias = alias</span>
<span class="lineno">  252 </span><span class="spaces">      </span><span class="istickedoff">, volumeBody = body</span>
<span class="lineno">  253 </span><span class="spaces">      </span><span class="istickedoff">}</span>
<span class="lineno">  254 </span><span class="spaces">    </span><span class="istickedoff">}</span></span>
<span class="lineno">  255 </span>
<span class="lineno">  256 </span>-- FIXME: Too impure, and needs test: What elements of the input are modified?
<span class="lineno">  257 </span>volumeCitationForm :: Volume -&gt; DeformHandler f (Volume, Maybe Citation)
<span class="lineno">  258 </span><span class="decl"><span class="istickedoff">volumeCitationForm v = do</span>
<span class="lineno">  259 </span><span class="spaces">  </span><span class="istickedoff">csrfForm</span>
<span class="lineno">  260 </span><span class="spaces">  </span><span class="istickedoff">vol &lt;- volumeForm v</span>
<span class="lineno">  261 </span><span class="spaces">  </span><span class="istickedoff">cite &lt;- &quot;citation&quot; .:&gt; Citation</span>
<span class="lineno">  262 </span><span class="spaces">    </span><span class="istickedoff">&lt;$&gt; (&quot;head&quot; .:&gt; deform)</span>
<span class="lineno">  263 </span><span class="spaces">    </span><span class="istickedoff">&lt;*&gt; (&quot;url&quot; .:&gt; deformNonEmpty <span class="nottickedoff">deform</span>)</span>
<span class="lineno">  264 </span><span class="spaces">    </span><span class="istickedoff">&lt;*&gt; (&quot;year&quot; .:&gt; deformNonEmpty <span class="nottickedoff">deform</span>)</span>
<span class="lineno">  265 </span><span class="spaces">    </span><span class="istickedoff">&lt;*&gt; pure Nothing</span>
<span class="lineno">  266 </span><span class="spaces">  </span><span class="istickedoff">look &lt;- flatMapM <span class="nottickedoff">(lift . focusIO . lookupCitation)</span> $</span>
<span class="lineno">  267 </span><span class="spaces">    </span><span class="istickedoff">guard (T.null (volumeName $ volumeRow vol) || T.null (citationHead cite) || <span class="nottickedoff">isNothing (citationYear cite)</span>) &gt;&gt; citationURL cite</span>
<span class="lineno">  268 </span><span class="spaces">  </span><span class="istickedoff">let fill = maybe cite <span class="nottickedoff">(cite &lt;&gt;)</span> look</span>
<span class="lineno">  269 </span><span class="spaces">      </span><span class="istickedoff">empty = T.null (citationHead fill) &amp;&amp; isNothing (citationURL fill) &amp;&amp; isNothing (citationYear fill)</span>
<span class="lineno">  270 </span><span class="spaces">      </span><span class="istickedoff">name</span>
<span class="lineno">  271 </span><span class="spaces">        </span><span class="istickedoff">| Just title &lt;- citationTitle fill</span>
<span class="lineno">  272 </span><span class="spaces">        </span><span class="istickedoff">, <span class="nottickedoff">T.null (volumeName $ volumeRow vol)</span> = <span class="nottickedoff">title</span></span>
<span class="lineno">  273 </span><span class="spaces">        </span><span class="istickedoff">| <span class="tickonlytrue">otherwise</span> = volumeName $ volumeRow vol</span>
<span class="lineno">  274 </span><span class="spaces">  </span><span class="istickedoff">_ &lt;- <span class="nottickedoff">&quot;name&quot;</span> .:&gt; deformRequired name</span>
<span class="lineno">  275 </span><span class="spaces">  </span><span class="istickedoff">when (not empty) $ <span class="nottickedoff">void $</span></span>
<span class="lineno">  276 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">&quot;citation&quot; .:&gt; &quot;head&quot; .:&gt; deformRequired (citationHead fill)</span></span>
<span class="lineno">  277 </span><span class="spaces">  </span><span class="istickedoff">return (vol{ volumeRow = (volumeRow vol){ volumeName = name } }, empty `unlessUse` <span class="nottickedoff">fill</span>)</span></span>
<span class="lineno">  278 </span>
<span class="lineno">  279 </span>viewVolumeEdit :: ActionRoute (Id Volume)
<span class="lineno">  280 </span><span class="decl"><span class="istickedoff">viewVolumeEdit = action <span class="nottickedoff">GET</span> (pathHTML &gt;/&gt; pathId &lt;/&lt; &quot;edit&quot;) $ \_ -&gt; <span class="nottickedoff">withAuth $ do</span></span>
<span class="lineno">  281 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">angular</span></span>
<span class="lineno">  282 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">return (okResponse [] (&quot;&quot; :: String))</span></span></span> -- should never get here
<span class="lineno">  283 </span>  {-
<span class="lineno">  284 </span>  v &lt;- getVolume PermissionEDIT vi
<span class="lineno">  285 </span>  cite &lt;- lookupVolumeCitation v
<span class="lineno">  286 </span>  peeks $ blankForm . htmlVolumeEdit (Just (v, cite)) -}
<span class="lineno">  287 </span>
<span class="lineno">  288 </span>viewVolumeCreateHandler :: Action  -- TODO : GET only
<span class="lineno">  289 </span><span class="decl"><span class="nottickedoff">viewVolumeCreateHandler = withAuth $ do</span>
<span class="lineno">  290 </span><span class="spaces">  </span><span class="nottickedoff">angular</span>
<span class="lineno">  291 </span><span class="spaces">  </span><span class="nottickedoff">return (okResponse [] (&quot;&quot; :: String))</span></span> -- should never get here
<span class="lineno">  292 </span>  -- peeks $ blankForm . htmlVolumeEdit Nothing
<span class="lineno">  293 </span>
<span class="lineno">  294 </span>postVolume :: ActionRoute (Id Volume)
<span class="lineno">  295 </span><span class="decl"><span class="istickedoff">postVolume = action POST (pathJSON &gt;/&gt; pathId) $ \vi -&gt; <span class="nottickedoff">withAuth $ do</span></span>
<span class="lineno">  296 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">v &lt;- getVolume PermissionEDIT vi</span></span>
<span class="lineno">  297 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">cite &lt;- lookupVolumeCitation v</span></span>
<span class="lineno">  298 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">(v', cite') &lt;- runForm (Nothing :: Maybe (RequestContext -&gt; FormHtml a)) $ volumeCitationForm v</span></span>
<span class="lineno">  299 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">changeVolume v'</span></span>
<span class="lineno">  300 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">r &lt;- changeVolumeCitation v' cite'</span></span>
<span class="lineno">  301 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">return $ okResponse [] $</span></span>
<span class="lineno">  302 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">JSON.recordEncoding $ volumeJSONSimple v' `JSON.foldObjectIntoRec` (&quot;citation&quot; JSON..= if r then cite' else cite)</span></span></span>
<span class="lineno">  303 </span>    -- HTML -&gt; peeks $ otherRouteResponse [] viewVolume arg
<span class="lineno">  304 </span>
<span class="lineno">  305 </span>createVolume :: ActionRoute ()
<span class="lineno">  306 </span><span class="decl"><span class="istickedoff">createVolume = action POST (pathJSON &gt;/&gt; &quot;volume&quot;) $ \() -&gt; withAuth $ do</span>
<span class="lineno">  307 </span><span class="spaces">  </span><span class="istickedoff">u &lt;- peek</span>
<span class="lineno">  308 </span><span class="spaces">  </span><span class="istickedoff">(bv, cite, owner) &lt;- runForm <span class="nottickedoff">(Nothing :: Maybe (RequestContext -&gt; FormHtml a))</span> $ do</span>
<span class="lineno">  309 </span><span class="spaces">    </span><span class="istickedoff">csrfForm</span>
<span class="lineno">  310 </span><span class="spaces">    </span><span class="istickedoff">(bv, cite) &lt;- volumeCitationForm blankVolume</span>
<span class="lineno">  311 </span><span class="spaces">    </span><span class="istickedoff">own &lt;- &quot;owner&quot; .:&gt; do</span>
<span class="lineno">  312 </span><span class="spaces">      </span><span class="istickedoff">oi &lt;- deformOptional deform</span>
<span class="lineno">  313 </span><span class="spaces">      </span><span class="istickedoff">own &lt;- maybe (return $ Just $ selfAuthorize u) <span class="nottickedoff">(lift . lookupAuthorizeParent u)</span> $ mfilter (partyId (partyRow u) /=) oi</span>
<span class="lineno">  314 </span><span class="spaces">      </span><span class="istickedoff">deformMaybe' <span class="nottickedoff">&quot;You are not authorized to create volumes for that owner.&quot;</span> $</span>
<span class="lineno">  315 </span><span class="spaces">        </span><span class="istickedoff">authorizeParent . authorization &lt;$&gt; mfilter ((PermissionADMIN &lt;=) . accessMember) own</span>
<span class="lineno">  316 </span><span class="spaces">    </span><span class="istickedoff">auth &lt;- lift $ lookupAuthorization own rootParty</span>
<span class="lineno">  317 </span><span class="spaces">    </span><span class="istickedoff">deformGuard <span class="nottickedoff">&quot;Insufficient site authorization to create volume.&quot;</span> $</span>
<span class="lineno">  318 </span><span class="spaces">      </span><span class="istickedoff">PermissionEDIT &lt;= accessSite auth</span>
<span class="lineno">  319 </span><span class="spaces">    </span><span class="istickedoff">return (bv, cite, own)</span>
<span class="lineno">  320 </span><span class="spaces">  </span><span class="istickedoff">v &lt;- addVolume bv</span>
<span class="lineno">  321 </span><span class="spaces">  </span><span class="istickedoff">_ &lt;- changeVolumeCitation v cite</span>
<span class="lineno">  322 </span><span class="spaces">  </span><span class="istickedoff">setDefaultVolumeAccessesForCreated owner v</span>
<span class="lineno">  323 </span><span class="spaces">  </span><span class="istickedoff">when (on (/=) (partyId . partyRow) owner u) $ <span class="nottickedoff">forM_ (partyAccount owner) $ \t -&gt;</span></span>
<span class="lineno">  324 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">createNotification (blankNotification t NoticeVolumeCreated)</span></span>
<span class="lineno">  325 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">{ notificationVolume = Just $ volumeRow v</span></span>
<span class="lineno">  326 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">, notificationParty = Just $ partyRow owner</span></span>
<span class="lineno">  327 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">}</span></span>
<span class="lineno">  328 </span><span class="spaces">  </span><span class="istickedoff">return $ okResponse [] $ JSON.recordEncoding $ volumeJSONSimple v</span></span>
<span class="lineno">  329 </span>  -- HTML -&gt; peeks $ otherRouteResponse [] viewVolume (api, volumeId $ volumeRow v)
<span class="lineno">  330 </span>
<span class="lineno">  331 </span>{-
<span class="lineno">  332 </span>viewVolumeLinks :: ActionRoute (Id Volume)
<span class="lineno">  333 </span>viewVolumeLinks = action GET (pathHTML &gt;/&gt; pathId &lt;/&lt; &quot;link&quot;) $ \vi -&gt; withAuth $ do
<span class="lineno">  334 </span>  v &lt;- getVolume PermissionEDIT vi
<span class="lineno">  335 </span>  links &lt;- lookupVolumeLinks v
<span class="lineno">  336 </span>  peeks $ blankForm . htmlVolumeLinksEdit v links
<span class="lineno">  337 </span>-}
<span class="lineno">  338 </span>
<span class="lineno">  339 </span>postVolumeLinks :: ActionRoute (Id Volume)
<span class="lineno">  340 </span><span class="decl"><span class="istickedoff">postVolumeLinks = action <span class="nottickedoff">POST</span> (pathJSON &gt;/&gt; pathId &lt;/&lt; &quot;link&quot;) $ \vi -&gt; <span class="nottickedoff">withAuth $ do</span></span>
<span class="lineno">  341 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">v &lt;- getVolume PermissionEDIT vi</span></span>
<span class="lineno">  342 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">-- links &lt;- lookupVolumeLinks v</span></span>
<span class="lineno">  343 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">links' &lt;- runForm (Nothing :: Maybe (RequestContext -&gt; FormHtml a)) $ do</span></span>
<span class="lineno">  344 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">csrfForm</span></span>
<span class="lineno">  345 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">withSubDeforms $ \_ -&gt; Citation</span></span>
<span class="lineno">  346 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">&lt;$&gt; (&quot;head&quot; .:&gt; deform)</span></span>
<span class="lineno">  347 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">&lt;*&gt; (&quot;url&quot; .:&gt; (Just &lt;$&gt; deform))</span></span>
<span class="lineno">  348 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">&lt;*&gt; pure Nothing</span></span>
<span class="lineno">  349 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">&lt;*&gt; pure Nothing</span></span>
<span class="lineno">  350 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">changeVolumeLinks v links'</span></span>
<span class="lineno">  351 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">return $ okResponse [] $ JSON.recordEncoding $ volumeJSONSimple v `JSON.foldObjectIntoRec` (&quot;links&quot; JSON..= links')</span></span></span>
<span class="lineno">  352 </span>  -- HTML -&gt; peeks $ otherRouteResponse [] viewVolume arg
<span class="lineno">  353 </span>
<span class="lineno">  354 </span>postVolumeAssist :: ActionRoute (Id Volume)
<span class="lineno">  355 </span><span class="decl"><span class="istickedoff">postVolumeAssist = action <span class="nottickedoff">POST</span> (pathJSON &gt;/&gt; pathId &lt;/&lt; &quot;assist&quot;) $ \vi -&gt; <span class="nottickedoff">withAuth $ do</span></span>
<span class="lineno">  356 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">user &lt;- authAccount</span></span>
<span class="lineno">  357 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">v &lt;- getVolume PermissionEDIT vi</span></span>
<span class="lineno">  358 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">addr &lt;- peeks staticAssistAddr</span></span>
<span class="lineno">  359 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">cont &lt;- parseRequestContent (const 0)</span></span>
<span class="lineno">  360 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">body &lt;- case cont :: Content () of</span></span>
<span class="lineno">  361 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">ContentText body -&gt; return body</span></span>
<span class="lineno">  362 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">_ -&gt; result $ emptyResponse unsupportedMediaType415 []</span></span>
<span class="lineno">  363 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">sendMail [Left addr] [Right user] (&quot;Databrary upload assistance request for volume &quot; &lt;&gt; T.pack (show vi)) $ TL.fromChunks</span></span>
<span class="lineno">  364 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">[ partyName $ partyRow $ accountParty user, &quot; has requested curation assistance for &quot;, volumeName $ volumeRow v, &quot;\n\n&quot; ] &lt;&gt; body `TL.snoc` '\n'</span></span>
<span class="lineno">  365 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">createVolumeNotification v ($ NoticeVolumeAssist)</span></span>
<span class="lineno">  366 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">return $ emptyResponse noContent204 []</span></span></span>
<span class="lineno">  367 </span>
<span class="lineno">  368 </span>volumeSearchForm :: DeformHandler f VolumeFilter
<span class="lineno">  369 </span><span class="decl"><span class="nottickedoff">volumeSearchForm = VolumeFilter</span>
<span class="lineno">  370 </span><span class="spaces">  </span><span class="nottickedoff">&lt;$&gt; (&quot;query&quot; .:&gt; deformNonEmpty deform)</span>
<span class="lineno">  371 </span><span class="spaces">  </span><span class="nottickedoff">&lt;*&gt; (&quot;party&quot; .:&gt; optional deform)</span>
<span class="lineno">  372 </span><span class="spaces">  </span><span class="nottickedoff">&lt;*&gt; paginateForm</span></span>
<span class="lineno">  373 </span>
<span class="lineno">  374 </span>queryVolumes :: ActionRoute API
<span class="lineno">  375 </span><span class="decl"><span class="istickedoff">queryVolumes = action GET (pathAPI &lt;/&lt; &quot;volume&quot;) $ \api -&gt; <span class="nottickedoff">withAuth $ do</span></span>
<span class="lineno">  376 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">when (api == HTML) angular</span></span>
<span class="lineno">  377 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">vf &lt;- runForm (Nothing :: Maybe (RequestContext -&gt; FormHtml a)) volumeSearchForm</span></span>
<span class="lineno">  378 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">p &lt;- findVolumes vf</span></span>
<span class="lineno">  379 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">return $ okResponse [] $ JSON.mapRecords (\v -&gt; volumeJSONSimple v) p</span></span></span>
<span class="lineno">  380 </span>  -- HTML -&gt; peeks $ blankForm . htmlVolumeSearch vf p
<span class="lineno">  381 </span>
<span class="lineno">  382 </span>thumbVolume :: ActionRoute (Id Volume)
<span class="lineno">  383 </span><span class="decl"><span class="istickedoff">thumbVolume = action GET (pathId &lt;/&lt; &quot;thumb&quot;) $ \vi -&gt; withAuth $ do</span>
<span class="lineno">  384 </span><span class="spaces">  </span><span class="istickedoff">v &lt;- getVolume PermissionPUBLIC vi</span>
<span class="lineno">  385 </span><span class="spaces">  </span><span class="istickedoff">e &lt;- lookupVolumeThumb v</span>
<span class="lineno">  386 </span><span class="spaces">  </span><span class="istickedoff">maybe</span>
<span class="lineno">  387 </span><span class="spaces">    </span><span class="istickedoff">(peeks $ otherRouteResponse [] webFile (Just $ staticPath [&quot;images&quot;, &quot;draft.png&quot;]))</span>
<span class="lineno">  388 </span><span class="spaces">    </span><span class="istickedoff">(\as -&gt; peeks $ otherRouteResponse [] downloadAssetSegment (slotId $ view as, view as))</span>
<span class="lineno">  389 </span><span class="spaces">    </span><span class="istickedoff">e</span></span>

</pre>
</body>
</html>
