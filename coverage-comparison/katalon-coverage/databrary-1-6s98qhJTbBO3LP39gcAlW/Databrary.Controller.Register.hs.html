<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE OverloadedStrings #-}
<span class="lineno">    2 </span>module Databrary.Controller.Register
<span class="lineno">    3 </span>  ( passwordResetHandler
<span class="lineno">    4 </span>  , viewPasswordReset
<span class="lineno">    5 </span>  , postPasswordReset
<span class="lineno">    6 </span>  , registerHandler
<span class="lineno">    7 </span>  , viewRegister
<span class="lineno">    8 </span>  , postRegister
<span class="lineno">    9 </span>  , resendInvestigatorHandler
<span class="lineno">   10 </span>  , resendInvestigator
<span class="lineno">   11 </span>  ) where
<span class="lineno">   12 </span>
<span class="lineno">   13 </span>import Control.Applicative ((&lt;$&gt;))
<span class="lineno">   14 </span>import qualified Data.ByteString as BS
<span class="lineno">   15 </span>import qualified Data.ByteString.Builder as BSB
<span class="lineno">   16 </span>import qualified Data.ByteString.Char8 as BSC
<span class="lineno">   17 </span>import Data.Monoid ((&lt;&gt;))
<span class="lineno">   18 </span>import qualified Data.Text as T
<span class="lineno">   19 </span>import qualified Data.Text.Encoding as TE
<span class="lineno">   20 </span>import qualified Data.Text.Lazy as TL
<span class="lineno">   21 </span>import qualified Data.Text.Lazy.Encoding as TLE
<span class="lineno">   22 </span>import Network.HTTP.Types.Method (methodGet, methodPost)
<span class="lineno">   23 </span>import qualified Network.HTTP.Types.Method as HTM
<span class="lineno">   24 </span>import Servant (FromHttpApiData(..))
<span class="lineno">   25 </span>
<span class="lineno">   26 </span>import Databrary.Ops
<span class="lineno">   27 </span>import Databrary.Has
<span class="lineno">   28 </span>import Databrary.Service.Mail
<span class="lineno">   29 </span>import Databrary.Static.Fillin
<span class="lineno">   30 </span>import Databrary.Model.Permission
<span class="lineno">   31 </span>import Databrary.Model.Id
<span class="lineno">   32 </span>import Databrary.Model.Party
<span class="lineno">   33 </span>import Databrary.Model.Identity
<span class="lineno">   34 </span>import Databrary.Model.Token
<span class="lineno">   35 </span>import Databrary.HTTP.Form.Deform
<span class="lineno">   36 </span>import Databrary.HTTP.Path.Parser
<span class="lineno">   37 </span>import Databrary.Action
<span class="lineno">   38 </span>import Databrary.Controller.Paths
<span class="lineno">   39 </span>import Databrary.Controller.Form
<span class="lineno">   40 </span>import Databrary.Controller.Permission
<span class="lineno">   41 </span>import Databrary.Controller.Party
<span class="lineno">   42 </span>import Databrary.Controller.Token
<span class="lineno">   43 </span>import Databrary.Controller.Angular
<span class="lineno">   44 </span>import Databrary.View.Register
<span class="lineno">   45 </span>
<span class="lineno">   46 </span>resetPasswordMail :: Either BS.ByteString SiteAuth -&gt; T.Text -&gt; (Maybe TL.Text -&gt; TL.Text) -&gt; Handler ()
<span class="lineno">   47 </span><span class="decl"><span class="istickedoff">resetPasswordMail (Left email) subj body =</span>
<span class="lineno">   48 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">sendMail [Left email] [] subj (body Nothing)</span></span>
<span class="lineno">   49 </span><span class="spaces"></span><span class="istickedoff">resetPasswordMail (Right auth) subj body = do</span>
<span class="lineno">   50 </span><span class="spaces">  </span><span class="istickedoff">tok &lt;- loginTokenId =&lt;&lt; createLoginToken auth True</span>
<span class="lineno">   51 </span><span class="spaces">  </span><span class="istickedoff">req &lt;- peek</span>
<span class="lineno">   52 </span><span class="spaces">  </span><span class="istickedoff">sendMail [Right $ view auth] [] subj</span>
<span class="lineno">   53 </span><span class="spaces">    </span><span class="istickedoff">(body $ Just $ TLE.decodeLatin1 $ BSB.toLazyByteString $ actionURL (Just req) viewLoginToken (HTML, tok) [])</span></span>
<span class="lineno">   54 </span>
<span class="lineno">   55 </span>registerHandler :: API -&gt; HTM.Method -&gt; [(BS.ByteString, BS.ByteString)] -&gt; Action
<span class="lineno">   56 </span><span class="decl"><span class="istickedoff">registerHandler api method _</span>
<span class="lineno">   57 </span><span class="spaces">    </span><span class="istickedoff">| method == methodGet &amp;&amp; api == HTML = viewRegisterAction</span>
<span class="lineno">   58 </span><span class="spaces">    </span><span class="istickedoff">| <span class="tickonlytrue">method == methodPost</span> = postRegisterAction <span class="nottickedoff">api</span></span>
<span class="lineno">   59 </span><span class="spaces">    </span><span class="istickedoff">| <span class="nottickedoff">otherwise</span> = <span class="nottickedoff">error &quot;unhandled api/method combo&quot;</span></span></span> -- TODO: better error
<span class="lineno">   60 </span>
<span class="lineno">   61 </span>viewRegister :: ActionRoute ()
<span class="lineno">   62 </span><span class="decl"><span class="nottickedoff">viewRegister = action GET (pathHTML &lt;/&lt; &quot;user&quot; &lt;/&lt; &quot;register&quot;) $ \() -&gt; viewRegisterAction</span></span>
<span class="lineno">   63 </span>
<span class="lineno">   64 </span>viewRegisterAction :: Action
<span class="lineno">   65 </span><span class="decl"><span class="istickedoff">viewRegisterAction = withAuth $ do</span>
<span class="lineno">   66 </span><span class="spaces">  </span><span class="istickedoff">angular</span>
<span class="lineno">   67 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">maybeIdentity</span></span>
<span class="lineno">   68 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">(peeks $ blankForm . htmlRegister)</span></span>
<span class="lineno">   69 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">(\_ -&gt; peeks $ otherRouteResponse [] viewParty (HTML, TargetProfile))</span></span></span>
<span class="lineno">   70 </span>
<span class="lineno">   71 </span>postRegister :: ActionRoute API
<span class="lineno">   72 </span><span class="decl"><span class="nottickedoff">postRegister = action POST (pathAPI &lt;/&lt; &quot;user&quot; &lt;/&lt; &quot;register&quot;) $ postRegisterAction</span></span>
<span class="lineno">   73 </span>
<span class="lineno">   74 </span>postRegisterAction :: API -&gt; Action
<span class="lineno">   75 </span><span class="decl"><span class="istickedoff">postRegisterAction = \api -&gt; withoutAuth $ do</span>
<span class="lineno">   76 </span><span class="spaces">  </span><span class="istickedoff">reg &lt;- runForm <span class="nottickedoff">((api == HTML) `thenUse` htmlRegister)</span> $ do</span>
<span class="lineno">   77 </span><span class="spaces">    </span><span class="istickedoff">name &lt;- &quot;sortname&quot; .:&gt; (deformRequired =&lt;&lt; deform)</span>
<span class="lineno">   78 </span><span class="spaces">    </span><span class="istickedoff">prename &lt;- &quot;prename&quot; .:&gt; deformNonEmpty deform</span>
<span class="lineno">   79 </span><span class="spaces">    </span><span class="istickedoff">email &lt;- &quot;email&quot; .:&gt; emailTextForm</span>
<span class="lineno">   80 </span><span class="spaces">    </span><span class="istickedoff">affiliation &lt;- &quot;affiliation&quot; .:&gt; deformNonEmpty deform</span>
<span class="lineno">   81 </span><span class="spaces">    </span><span class="istickedoff">_ &lt;- &quot;agreement&quot; .:&gt; (deformCheck <span class="nottickedoff">&quot;You must consent to the user agreement.&quot;</span> id =&lt;&lt; deform)</span>
<span class="lineno">   82 </span><span class="spaces">    </span><span class="istickedoff">let p = blankParty</span>
<span class="lineno">   83 </span><span class="spaces">          </span><span class="istickedoff">{ partyRow = (partyRow blankParty)</span>
<span class="lineno">   84 </span><span class="spaces">            </span><span class="istickedoff">{ partySortName = name</span>
<span class="lineno">   85 </span><span class="spaces">            </span><span class="istickedoff">, partyPreName = prename</span>
<span class="lineno">   86 </span><span class="spaces">            </span><span class="istickedoff">, partyAffiliation = affiliation</span>
<span class="lineno">   87 </span><span class="spaces">            </span><span class="istickedoff">}</span>
<span class="lineno">   88 </span><span class="spaces">          </span><span class="istickedoff">, partyAccount = <span class="nottickedoff">Just a</span></span>
<span class="lineno">   89 </span><span class="spaces">          </span><span class="istickedoff">}</span>
<span class="lineno">   90 </span><span class="spaces">        </span><span class="istickedoff">a = Account</span>
<span class="lineno">   91 </span><span class="spaces">          </span><span class="istickedoff">{ accountParty = p</span>
<span class="lineno">   92 </span><span class="spaces">          </span><span class="istickedoff">, accountEmail = email</span>
<span class="lineno">   93 </span><span class="spaces">          </span><span class="istickedoff">}</span>
<span class="lineno">   94 </span><span class="spaces">    </span><span class="istickedoff">return a</span>
<span class="lineno">   95 </span><span class="spaces">  </span><span class="istickedoff">auth &lt;- maybe (SiteAuth &lt;$&gt; addAccount reg &lt;*&gt; pure <span class="nottickedoff">Nothing</span> &lt;*&gt; pure <span class="nottickedoff">mempty</span>) return =&lt;&lt; lookupSiteAuthByEmail False (accountEmail reg)</span>
<span class="lineno">   96 </span><span class="spaces">  </span><span class="istickedoff">resetPasswordMail (Right auth)</span>
<span class="lineno">   97 </span><span class="spaces">    </span><span class="istickedoff">&quot;Databrary account created&quot;</span>
<span class="lineno">   98 </span><span class="spaces">    </span><span class="istickedoff">$ \(Just url) -&gt;</span>
<span class="lineno">   99 </span><span class="spaces">      </span><span class="istickedoff">&quot;Thank you for registering with Databrary. Please use this link to complete your registration:\n\n&quot;</span>
<span class="lineno">  100 </span><span class="spaces">      </span><span class="istickedoff">&lt;&gt; url &lt;&gt; &quot;\n\n\</span>
<span class="lineno">  101 </span><span class="spaces">      </span><span class="istickedoff">\By clicking the above link, you also indicate that you have read and understand the Databrary Access agreement, which you can download here: http://databrary.org/policies/agreement.pdf\n\n\</span>
<span class="lineno">  102 </span><span class="spaces">      </span><span class="istickedoff">\Once you've validated your e-mail, you will be able to request authorization to be granted full access to Databrary.\n&quot;</span>
<span class="lineno">  103 </span><span class="spaces">  </span><span class="istickedoff">focusIO $ staticSendInvestigator <span class="nottickedoff">(view auth)</span></span>
<span class="lineno">  104 </span><span class="spaces">  </span><span class="istickedoff">return $ okResponse [] $ &quot;Your confirmation email has been sent to '&quot; &lt;&gt; accountEmail reg &lt;&gt; &quot;'.&quot;</span></span>
<span class="lineno">  105 </span>
<span class="lineno">  106 </span>resendInvestigator :: ActionRoute (Id Party)
<span class="lineno">  107 </span><span class="decl"><span class="nottickedoff">resendInvestigator = action POST (pathHTML &gt;/&gt; pathId &lt;/&lt; &quot;investigator&quot;) $</span>
<span class="lineno">  108 </span><span class="spaces">    </span><span class="nottickedoff">\i -&gt; resendInvestigatorHandler [(&quot;partyId&quot;, (BSC.pack . show) i)]</span></span>
<span class="lineno">  109 </span>
<span class="lineno">  110 </span>resendInvestigatorHandler :: [(BS.ByteString, BS.ByteString)] -&gt; Action
<span class="lineno">  111 </span><span class="decl"><span class="nottickedoff">resendInvestigatorHandler params = withAuth $ do  -- TODO: handle POST only</span>
<span class="lineno">  112 </span><span class="spaces">  </span><span class="nottickedoff">let paramId = maybe (error &quot;partyId missing&quot;) TE.decodeUtf8 (lookup &quot;partyId&quot; params)</span>
<span class="lineno">  113 </span><span class="spaces">  </span><span class="nottickedoff">let i = either (error . show) Id (parseUrlPiece paramId)</span>
<span class="lineno">  114 </span><span class="spaces">  </span><span class="nottickedoff">checkMemberADMIN</span>
<span class="lineno">  115 </span><span class="spaces">  </span><span class="nottickedoff">p &lt;- getParty (Just PermissionREAD) (TargetParty i)</span>
<span class="lineno">  116 </span><span class="spaces">  </span><span class="nottickedoff">focusIO $ staticSendInvestigator p</span>
<span class="lineno">  117 </span><span class="spaces">  </span><span class="nottickedoff">return $ okResponse [] (&quot;sent&quot; :: String)</span></span>
<span class="lineno">  118 </span>
<span class="lineno">  119 </span>passwordResetHandler :: API -&gt; HTM.Method -&gt; [(BS.ByteString, BS.ByteString)] -&gt; Action
<span class="lineno">  120 </span><span class="decl"><span class="istickedoff">passwordResetHandler api method _</span>
<span class="lineno">  121 </span><span class="spaces">    </span><span class="istickedoff">| <span class="tickonlytrue">method == methodGet &amp;&amp; api == HTML</span> = viewPasswordResetAction</span>
<span class="lineno">  122 </span><span class="spaces">    </span><span class="istickedoff">| <span class="nottickedoff">method == methodPost</span> = <span class="nottickedoff">postPasswordResetAction api</span></span>
<span class="lineno">  123 </span><span class="spaces">    </span><span class="istickedoff">| <span class="nottickedoff">otherwise</span> = <span class="nottickedoff">error &quot;unhandled api/method combo&quot;</span></span></span> -- TODO: better error
<span class="lineno">  124 </span>
<span class="lineno">  125 </span>viewPasswordReset :: ActionRoute ()
<span class="lineno">  126 </span><span class="decl"><span class="nottickedoff">viewPasswordReset = action GET (pathHTML &lt;/&lt; &quot;user&quot; &lt;/&lt; &quot;password&quot;) $ \() -&gt; viewPasswordResetAction</span></span>
<span class="lineno">  127 </span>
<span class="lineno">  128 </span>viewPasswordResetAction :: Action
<span class="lineno">  129 </span><span class="decl"><span class="istickedoff">viewPasswordResetAction = withoutAuth $ do</span>
<span class="lineno">  130 </span><span class="spaces">  </span><span class="istickedoff">angular</span>
<span class="lineno">  131 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">peeks $ blankForm . htmlPasswordReset</span></span></span>
<span class="lineno">  132 </span>
<span class="lineno">  133 </span>postPasswordReset :: ActionRoute API
<span class="lineno">  134 </span><span class="decl"><span class="nottickedoff">postPasswordReset = action POST (pathAPI &lt;/&lt; &quot;user&quot; &lt;/&lt; &quot;password&quot;) $ postPasswordResetAction</span></span>
<span class="lineno">  135 </span>
<span class="lineno">  136 </span>postPasswordResetAction :: API -&gt; Action
<span class="lineno">  137 </span><span class="decl"><span class="nottickedoff">postPasswordResetAction = \api -&gt; withoutAuth $ do</span>
<span class="lineno">  138 </span><span class="spaces">  </span><span class="nottickedoff">email &lt;- runForm ((api == HTML) `thenUse` htmlPasswordReset) $ do</span>
<span class="lineno">  139 </span><span class="spaces">    </span><span class="nottickedoff">&quot;email&quot; .:&gt; emailTextForm</span>
<span class="lineno">  140 </span><span class="spaces">  </span><span class="nottickedoff">auth &lt;- lookupPasswordResetAccount email</span>
<span class="lineno">  141 </span><span class="spaces">  </span><span class="nottickedoff">resetPasswordMail (maybe (Left email) Right auth)</span>
<span class="lineno">  142 </span><span class="spaces">    </span><span class="nottickedoff">&quot;Databrary password reset&quot; $</span>
<span class="lineno">  143 </span><span class="spaces">    </span><span class="nottickedoff">(&quot;Someone (hopefully you) has requested to reset the password for the Databrary account associated with this email address. If you did not request this, let us know (by replying to this message) or simply ignore it.\n\n&quot; &lt;&gt;)</span>
<span class="lineno">  144 </span><span class="spaces">    </span><span class="nottickedoff">. maybe</span>
<span class="lineno">  145 </span><span class="spaces">      </span><span class="nottickedoff">&quot;Unfortunately, no Databrary account was found for this email address. You can try again with a different email address, or reply to this email for assistance.\n&quot;</span>
<span class="lineno">  146 </span><span class="spaces">      </span><span class="nottickedoff">(&quot;Otherwise, you may use this link to reset your Databrary password:\n\n&quot; &lt;&gt;)</span>
<span class="lineno">  147 </span><span class="spaces">  </span><span class="nottickedoff">return $ okResponse [] $ &quot;Your password reset information has been sent to '&quot; &lt;&gt; email &lt;&gt; &quot;'.&quot;</span></span>
<span class="lineno">  148 </span>

</pre>
</body>
</html>
